---
title: "1_nuseds_collation"
author: "Bruno S. Carturan"
date: "2025-01-24"
output: 
  html_document:
    toc: true                  # Adds a table of contents to the document
    toc_float: true           # Makes the table of contents float on the side as the reader scrolls.
    toc_collapsed: true        # Starts the table of contents in a collapsed state.
    toc_depth: 3               # Specifies the depth of headers (e.g., ##, ###) to include in the table of contents.
    number_sections: true      # 
    theme: journal  # lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

The goal of the script is to fix issues in NuSEDS and to merge the two constituent datasets **all_areas_nuseds** (referred to as **NUSEDS**) and **conservation_unit_system_sites** (referred to as **CUSS**).

The dataset version corresponding to this script is:

Fisheries and Oceans Canada. 2024. NuSEDS - New Salmon Escapement Database System. Pacific Biological Station. Retrieved January 22, 2024, from https://open.canada.ca/data/en/dataset/c48669a3-045b-400d-b730-48aafe8c5ee6.


```{r, include = F}

#'******************************************************************************
#' The goal of the script is to import, clean and format NuSEDS data.
#' Script based on Emma Atkinson's previous version (26-Mar-2019).
#' 
#' Files imported:
#' - conservationunits_decoder.csv (from database)
#' - streamlocationids.csv (from database)
#' - all_areas_nuseds_DATE.csv (from DFO)
#' - conservation_unit_system_sites_DATE.csv (from DFO)
#' - nuseds_report_definitions.csv (from DFO)
#' - conservation_unit_report_definitions.csv (from DFO)
#' - DFO_GFE_IDs_list_1.xlsx (from Wu Zhipeng, DFO)
#' - DFO_GFE_IDs_list_2.xlsx (from Wu Zhipeng, DFO)
#' 
#' Files produced: 
#' - 1_all_areas_nuseds_cleaned_DATE.csv
#' - 1_conservation_unit_system_sites_cleaned_DATE.csv
#' - 1_NuSEDS_escapement_data_collated_DATE.csv         # the merged and further corrected all_areas_nuseds and conservation_unit_system_sites
#' - 1_series_inNUSEDS_noInCUSS_DATE.csv                # series removed because no alternative series could be found in conservation_unit_system_sites; to investigate later may be
#' - 1_series_removed_DATE.csv                          # series removed from either datasets and why
#' - 1_series_added_DATE.csv                            # series added to either dataset and why
#' - 1_log_file.csv                                     # the log file containing the name of the orginak NUSEDS and CUSS files imported and the information about 0s being removed or not.

#'******************************************************************************

# NOTE (to remove eventually): original script is:
# 1_nuseds_data_collationJun72023.R in:
# \X Drive\1_PROJECTS\1_Active\Fraser_VIMI\analysis\Compilation\Code

rm(list = ls())
graphics.off()

# Loading packages & functions
library(tidyr)
library(plyr)
library(dplyr)
library(readxl)
library(parallel)
library(sp) # to calculate distances from geo-spatial coordinates
# library(dplyr)
# library(tibble)
# library(scales)
# library(ggplot2)
# library(reshape2)
# library(stringr)
# library(viridis)

# reset the wd to head using the location of the current script
path <- rstudioapi::getActiveDocumentContext()$path
dirhead <- "population-indicators"
path_ahead <- sub(pattern = paste0("\\",dirhead,".*"),replacement = "", x = path)
wd_head <- paste0(path_ahead,dirhead)
setwd(wd_head)

# Now import functions related to directories.
# Note that the script cannot be called again once the directory is set to the 
# subdirectory of the project (unless setwd() is called again).
source("code/functions_set_wd.R")
source("code/functions_general.R")

# return the name of the directories for the different projects:
subDir_projects <- subDir_projects_fun()

wds_l <- set_working_directories_fun(subDir = subDir_projects$spawner_surveys,
                                     Export_locally = F)
wd_head <- wds_l$wd_head
wd_project <- wds_l$wd_project
wd_code <- wds_l$wd_code
wd_data <- wds_l$wd_data
wd_figures <- wds_l$wd_figures
wd_output <- wds_l$wd_output
wd_X_Drive1_PROJECTS <- wds_l$wd_X_Drive1_PROJECTS

wd_references_dropbox <- paste(wd_X_Drive1_PROJECTS,
                               wds_l$wd_project_dropbox,
                               "references",sep="/")

wd_data_dropbox <- paste(wd_X_Drive1_PROJECTS,
                         wds_l$wd_project_dropbox,
                         "data",sep="/")

wd_documents <- paste(wd_project,"documents",sep="/")

wd_pop_indic_data_input_dropbox <- paste(wd_X_Drive1_PROJECTS,
                                         wds_l$wd_population_indicator_data_input_dropbox,
                                         sep = "/")


source("code/functions.R")

options(digits = 9)


#'* !!! DECISIONS TO MAKE !!! *

# Set tp true to update the datasets
export_datasets <- F  

# Decision in ## Remove the IndexId & GFE_ID time series in NUSEDS with only NAs and/or 0s
# If TRUE, time series only composed of NAs and/or 0s are removed from NUSEDS; 
# If FALSE, time series only composed of NAs are removed from NUSEDS.
remove_timeSeries_zeros_too <- F # 

# Used just after NUSEDS and CUSS are merged: to decide if we want to replace
# all the remainning 0s by NAs.
replace_zeros_byNAs <- T
```

# Import datasets

The NuSEDS (all_areas_nuseds) and CUSS (conservation_unit_system_sites) datasets are imported and duplicated rows are removed. The columns considered for NuSEDS are related to the population, location, fish counts and year of assessment:

```{r,include=FALSE}
#'* Import the all_areas_nuseds data ("NUSEDS) *
all_areas_nuseds <- datasets_NuSEDS_fun(name_dataSet = "all_areas_nuseds", 
                                        from_NuSEDS_website = F, 
                                         wd = wd_data_dropbox)

# Record the name of the all_areas_nuseds file name for the log file: 
files_c <- list.files(wd_data_dropbox)
files_c <- files_c[grepl(x = files_c, pattern = "all_areas_nuseds")]
file.mtime <- file.mtime(paste(wd_data_dropbox,files_c,sep="/"))
all_areas_nuseds_file_name <- files_c[file.mtime == max(file.mtime)]
```

```{r, echo=FALSE}
cols_NuSEDS <- c("SPECIES","POP_ID","GFE_ID","ANALYSIS_YR",
                 "NATURAL_ADULT_SPAWNERS","NATURAL_JACK_SPAWNERS",
                 "NATURAL_SPAWNERS_TOTAL","ADULT_BROODSTOCK_REMOVALS",
                 "JACK_BROODSTOCK_REMOVALS","TOTAL_BROODSTOCK_REMOVALS",
                 "OTHER_REMOVALS","TOTAL_RETURN_TO_RIVER")

cols_NuSEDS
```
```{r, include=FALSE}
#' Remove duplicated rows:
# dupli <- all_areas_nuseds %>%
#   dplyr::group_by(SPECIES, POP_ID, GFE_ID, ANALYSIS_YR,
#                   NATURAL_ADULT_SPAWNERS,NATURAL_JACK_SPAWNERS,        
#                   NATURAL_SPAWNERS_TOTAL, ADULT_BROODSTOCK_REMOVALS, 
#                   JACK_BROODSTOCK_REMOVALS, TOTAL_BROODSTOCK_REMOVALS,    
#                   OTHER_REMOVALS, TOTAL_RETURN_TO_RIVER) %>%
#   dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
#   dplyr::filter(n > 1L)
# 
# dupli # one

dupli <- duplicated(all_areas_nuseds[,cols_NuSEDS])
```

The following `r sum(dupli)` duplicated rows in NuSEDS when considering these columns are removed:

```{r,echo=FALSE}
toRemove_r <- which(dupli)
all_areas_nuseds[toRemove_r,cols_NuSEDS]
```

```{r, include=FALSE}
all_areas_nuseds <- all_areas_nuseds[-toRemove_r,]
```

```{r, include=FALSE}
#'* Import conservation_unit_system_sites ("CUSS") *
# DFO provided files matching streams and Nuseds to full CU index 
conservation_unit_system_sites <- datasets_NuSEDS_fun(name_dataSet = "conservation_unit_system_sites", 
                                                      from_NuSEDS_website = F, 
                                                      wd = wd_data_dropbox)

#' check for duplicated rows: --> NONE
# dupli <- conservation_unit_system_sites %>%
#   dplyr::group_by(SPECIES_QUALIFIED,POP_ID,GFE_ID) %>%
#   dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
#   dplyr::filter(n > 1L)

dupli <- duplicated(conservation_unit_system_sites)

# Record the name of the conservation_unit_system_sites file name for the log file: 
files_c <- list.files(wd_data_dropbox)
files_c <- files_c[grepl(x = files_c, pattern = "conservation_unit_system_sites")]
file.mtime <- file.mtime(paste(wd_data_dropbox,files_c,sep="/"))
conservation_unit_system_sites_file_name <- files_c[file.mtime == max(file.mtime)]
```

For CUSS, `r sum(dupli)` duplicated rows are found:

```{r, echo=FALSE}
toRemove_r <- which(dupli)
conservation_unit_system_sites[toRemove_r,]
```

```{r, include=FALSE}
conservation_unit_system_sites[-toRemove_r,]
```


```{r, include=FALSE}
#'* Import the definition of the different fields of these two datasets *
fields_def <- nuseds_fields_definitions_fun(wd_references = wd_references_dropbox)
# fields_def$all_areas_nuseds$AREA
# fields_def$cu_system_sites$IS_INDICATOR


#'* Import list for the fields in NUSEDS and CUSS that are associated to unique IndexId and GFE_ID *
#' IndexId is define below as the species acronym + _ + POP_ID
#' Those are used to updated all the columns/fields in NUSEDS and CUSS when adding
#' or updating a population. 
fields_l <- fields_IndexId_GFE_ID_fun(all_areas_nuseds = all_areas_nuseds,
                                      conservation_unit_system_sites = conservation_unit_system_sites)

# fields_l$NUSEDS$IndexId

#'* Create a dataframe with the species names and the different acronymes *
sp_salmon_detail <- c("Chum", "Chinook", "Coho", "Pink even","Pink odd","Sockeye lake","Sockeye river")
sp_salmon <-        c("Chum", "Chinook", "Coho", "Pink","Pink","Sockeye","Sockeye")
sp_salmon_acro <-     c("CM", "CK", "CO", "PKE", "PKO", "SEL", "SER")
sp_salmon_acro_ncc <- c("CM", "CN", "CO", "PKE", "PKO",  "SX",  "SX")  # SpeciesId ; NCC Salmon Database (NCCSDB) Designation 

sp_salmon_names_acro_df <- data.frame(name = sp_salmon,
                                      name_detail = sp_salmon_detail,
                                      acronym = sp_salmon_acro,
                                      acronym_ncc = sp_salmon_acro_ncc)
```

The list of conservation units (CUs) as shown in the Pacific Salmon Explorer ([PSE](https://www.salmonexplorer.ca/)) is imported. The columns `cu_name_pse` and `cu_name_dfo` correspond to `CU_NAME` in CUSS, `cu_index` corresponds to `FULL_CU_INDEX`.

```{r, include=FALSE}
#'* Import the PSE list of CUs (conservationunits_decoder) *
fromDatabase <- F
update_file_csv <- F
conservationunits_decoder <- datasets_database_fun(nameDataSet = "conservationunits_decoder.csv",
                                                   fromDatabase = fromDatabase,
                                                   update_file_csv = update_file_csv,
                                                   wd = wd_pop_indic_data_input_dropbox)
```
```{r, echo=FALSE}
head(conservationunits_decoder[,c("region","species_name","species_abbr","cuid","cu_name_pse","cu_name_dfo","cu_index")])
```

The DFO file of the stream locations and coordinates (emailed from Wu Zhipeng, DFO, 09/04/2024) is imported. The columns `NME` and `ID` correspond to `SYSTEM_SITE` and `GFE_ID` in CUSS, respectively.

```{r, echo=FALSE}
#'* Import streamlocationids *
# streamlocationids <- datasets_database_fun(nameDataSet = "streamlocationids.csv",
#                                            fromDatabase = fromDatabase,
#                                            update_file_csv = update_file_csv,
#                                            wd = wd_pop_indic_data_input_dropbox)

#'* Import the stream - GFE_ID data file from DFO *
#' (emailed from Wu Zhipeng, DFO, 09/04/2024)
#' There are different locations in the 2nd first sheets to we combine them into a unique dataframe
DFO_All_Streams_Segments <- read_xlsx(paste0(wd_data_dropbox,"/DFO_All_Streams_Segments_20240408.xlsx"),
                                      sheet = "All Streams")

DFO_All_Streams_Segments2 <- read_xlsx(paste0(wd_data_dropbox,"/DFO_All_Streams_Segments_20240408.xlsx"),
                                      sheet = "Stream Segments")

# Emailed as "GFE_IDs.xlsx"
# DFO_All_Streams_Segments3 <- read_xlsx(paste0(wd_data_dropbox,"/DFO_GFE_IDs_list_1.xlsx"),
#                                       sheet = "Export Worksheet")

# Emailed as "GFE_IDs_20240305.xlsx"
# DFO_All_Streams_Segments4 <- read_xlsx(paste0(wd_data_dropbox,"/DFO_GFE_IDs_list_2.xlsx"),
#                                        sheet = "Export Worksheet")

columns <- c("NME","ID","X_LONGT","Y_LAT")
DFO_All_Streams_Segments <- rbind(DFO_All_Streams_Segments[,columns],
                                  DFO_All_Streams_Segments2[,columns]
                                  # DFO_All_Streams_Segments3[,columns],
                                  # DFO_All_Streams_Segments4[,columns]
                                  )
DFO_All_Streams_Segments <- unique(DFO_All_Streams_Segments)

rm(DFO_All_Streams_Segments2)
head(DFO_All_Streams_Segments)
```

```{r, include=F}
# streamlocationids$sys_nm <- tolower(streamlocationids$sys_nm)
# streamlocationids$cu_name_pse <- tolower(streamlocationids$cu_name_pse)
# 
# # Add species_name to streamlocationids
# cuids <- unique(streamlocationids$cuid)
# streamlocationids$species_name <- NA
# for(c in cuids){
#   cond <- conservationunits_decoder$cuid == c
#   if(sum(cond) > 0){
#     streamlocationids$species_name[streamlocationids$cuid == c] <- conservationunits_decoder$species_name[cond]
#   }
# }
```


# Initial modidifications

```{r, include=FALSE}

#'* Remove rows for Atlantic, Steelhead, and Kokanee *

row_remove <- all_areas_nuseds$SPECIES %in% c("Steelhead","Atlantic","Kokanee")
nb_rows_NUSEDS <- sum(row_remove)
nb_POP_ID_NUSEDS <- length(unique(all_areas_nuseds$POP_ID[row_remove]))

all_areas_nuseds <- all_areas_nuseds[!row_remove,]

# all_areas_nuseds <- dplyr::filter(all_areas_nuseds, 
#                                   !SPECIES %in% c("Steelhead","Atlantic","Kokanee"))

row_remove <- !conservation_unit_system_sites$SPECIES_QUALIFIED %in% c("CK","CO","PKE","PKO","CM","SEL","SER")
nb_rows_CUSS <- sum(row_remove)
nb_POP_ID_CUSS <- length(unique(conservation_unit_system_sites$POP_ID[row_remove]))

conservation_unit_system_sites <- conservation_unit_system_sites[!row_remove,]

# conservation_unit_system_sites <- dplyr::filter(conservation_unit_system_sites, 
#                                                 SPECIES_QUALIFIED %in% sp_salmon_names_acro_df$acronym)

```

We remove from NUSEDS and CUSS data related to steelhead, Atlantic salmon and Kokanee salmon, corresponding to `r nb_rows_NUSEDS` rows and `r nb_POP_ID_NUSEDS` populations (`POP_ID`) in NUSEDS and `r nb_rows_CUSS` in CUSS.


```{r, include=FALSE}

#'* Rename the year column *
colnames(all_areas_nuseds)[colnames(all_areas_nuseds) == "ANALYSIS_YR"] <- "Year"

#'* Add the field SPECIES to CUSS *
conservation_unit_system_sites$SPECIES <- NA
species <- c("Coho","Chinook","Pink","Pink","Chum","Sockeye","Sockeye")
sp_acronym_q <- c("CO","CK","PKE","PKO","CM","SEL","SER")
for(spq in sp_acronym_q){
  # spq <- sp_acronym_q[1]
  condition <- conservation_unit_system_sites$SPECIES_QUALIFIED == spq
  sp_Here <- unique(species[spq == sp_acronym_q])
  conservation_unit_system_sites$SPECIES[condition] <- sp_Here
}
unique(conservation_unit_system_sites$SPECIES)


#'* Create the field "species_acronym_ncc"to NUSEDS *
#' i.e., CN, SX instead of CK and SER or SEL in the SPECIES_QUALIFIED.
#' There is no information about sockeye river vs. lake in NUSEDS, 
#' contrary to in conservation_unit_system_sites. We consequently have to create
#' the field species_acronym_ncc in both dataset to be able to merge them after.
#' (Note that there is information about the rearing locations the fieldsWATERBODY,
#' GAZETTED_NAME, LOCAL_NAME_1, LOCAL_NAME_2, POPULATION).
all_areas_nuseds$species_acronym_ncc <- conservation_unit_system_sites$species_acronym_ncc <- NA
species <- c("Coho","Chinook","Pink","Chum","Sockeye")
species_acronym_ncc <- c("CO","CN","PK","CM","SX")
for(sp in species){
  # sp <- species[3]
  sp_acroHere <- species_acronym_ncc[sp == species]
  condition <- all_areas_nuseds$SPECIES == sp
  all_areas_nuseds$species_acronym_ncc[condition] <- sp_acroHere
  condition <- conservation_unit_system_sites$SPECIES == sp
  conservation_unit_system_sites$species_acronym_ncc[condition] <- sp_acroHere
  
  # For Pink, add E and O for Even and Odd, respectively
  if(sp == "Pink"){
    all_areas_nuseds$species_acronym_ncc[all_areas_nuseds$SPECIES == sp & 
                                           all_areas_nuseds$Year %% 2 == 0] <- "PKE"
    all_areas_nuseds$species_acronym_ncc[all_areas_nuseds$SPECIES == sp & 
                                           all_areas_nuseds$Year %% 2 != 0] <- "PKO"
    
    condition <- conservation_unit_system_sites$SPECIES_QUALIFIED == "PKE"
    conservation_unit_system_sites$species_acronym_ncc[condition] <- "PKE"
    
    condition <- conservation_unit_system_sites$SPECIES_QUALIFIED == "PKO"
    conservation_unit_system_sites$species_acronym_ncc[condition] <- "PKO"
  }
}
unique(all_areas_nuseds$species_acronym_ncc)
unique(conservation_unit_system_sites$species_acronym_ncc)

```

We create the column `IndexId`, which the the combination of the species acronym (i.e., CO, CM, CN, PKO, PKE, SX) and `POP_ID`:

```{r,echo=FALSE}
#' * Add the field IndexId = species_acronym_ncc + POP_ID *
all_areas_nuseds$IndexId <- paste(all_areas_nuseds$species_acronym_ncc,
                                  all_areas_nuseds$POP_ID,sep = "_")

conservation_unit_system_sites$IndexId <- paste(conservation_unit_system_sites$species_acronym_ncc,
                                                conservation_unit_system_sites$POP_ID,sep = "_")

head(unique(conservation_unit_system_sites$IndexId))
```
```{r, include=FALSE}
#'* Add the field StatArea to NUSEDS * 
#' Old code, not sure how important this is.
all_areas_nuseds$StatArea <- Convert2StatArea(all_areas_nuseds$AREA)
# Make corrections for populations with discrepancies in area assignments #
# These errors become apparent when merging data frames later on #
all_areas_nuseds[all_areas_nuseds$IndexId == "CO_46240",]$StatArea <- "29"    # vs. "29J" "29K"
all_areas_nuseds[all_areas_nuseds$IndexId == "PKO_51094",]$StatArea <- "12"  # BSC: there is one ""
all_areas_nuseds[all_areas_nuseds$IndexId == "SX_45495",]$StatArea <- "120"  # BSC: already "120"
```



```{r, include=F}

# The filed Returns is not used but we keep the code just in case.

#'* Determine "Returns" (i.e. number fish) in NUSEDS (NOT USED - TO REMOVED?) *
#' "Return" will be the column that contains the final fish count. Priority of the
#' fields to population Returns:
#'1) NATURAL_ADULT_SPAWNERS, if not available:
#'2) sum of 
#'  - NATURAL_SPAWNERS_TOTAL
#'  - ADULT_BROODSTOCK_REMOVALS (or TOTAL_BROODSTOCK_REMOVALS if not available)
#'  - OTHER_REMOVALS
#'3) TOTAL_RETURN_TO_RIVER

# Add "Return" which will contain the final number of fish
all_areas_nuseds$Returns <- all_areas_nuseds$NATURAL_ADULT_SPAWNERS         # All salmon that have reached maturity, excluding jacks (jacks are salmon that have matured at an early age).
all_areas_nuseds$Source <- "NATURAL_ADULT_SPAWNERS"                        # this field will change below depending on data availability and origin
NATURAL_ADULT_SPAWNERS_any <- !is.na(all_areas_nuseds$NATURAL_ADULT_SPAWNERS)
all_areas_nuseds$Source[!NATURAL_ADULT_SPAWNERS_any] <- NA

#' Define the sum of:
#' - "Spawner" = NATURAL_SPAWNERS_TOTAL +
#' - "Broodstock" = ADULT_BROODSTOCK_REMOVALS (or TOTAL_BROODSTOCK_REMOVALS if not available) + 
#' - "Removals" = OTHER_REMOVALS

# Spawners:
all_areas_nuseds$Spawners <- all_areas_nuseds$NATURAL_SPAWNERS_TOTAL
spawners_any <- !is.na(all_areas_nuseds$Spawners)
all_areas_nuseds$SpawnersSource[!NATURAL_ADULT_SPAWNERS_any & spawners_any] <- "NATURAL_SPAWNERS_TOTAL"

# Broodstock:
all_areas_nuseds$Broodstock <- all_areas_nuseds$ADULT_BROODSTOCK_REMOVALS
ADULT_BROODSTOCK_REMOVALS_any <- !is.na(all_areas_nuseds$ADULT_BROODSTOCK_REMOVALS)
TOTAL_BROODSTOCK_REMOVALS_any <- !is.na(all_areas_nuseds$TOTAL_BROODSTOCK_REMOVALS)
toReplace <- !ADULT_BROODSTOCK_REMOVALS_any & TOTAL_BROODSTOCK_REMOVALS_any
all_areas_nuseds$Broodstock[toReplace] <- all_areas_nuseds$TOTAL_BROODSTOCK_REMOVALS[toReplace]
all_areas_nuseds$BroodstockSource[!NATURAL_ADULT_SPAWNERS_any & ADULT_BROODSTOCK_REMOVALS_any] <- 'ADULT_BROODSTOCK_REMOVALS'
all_areas_nuseds$BroodstockSource[toReplace] <- 'TOTAL_BROODSTOCK_REMOVALS'

# Removals:
all_areas_nuseds$Removals <- all_areas_nuseds$OTHER_REMOVALS
OTHER_REMOVALS_any <- !is.na(all_areas_nuseds$OTHER_REMOVALS)
all_areas_nuseds$RemovalsSource[!NATURAL_ADULT_SPAWNERS_any & OTHER_REMOVALS_any] <- "OTHER_REMOVALS"

# Calculate Returns when !NATURAL_ADULT_SPAWNERS_any as the sum of what other 
# sources of data is available:
all_areas_nuseds$Returns[!NATURAL_ADULT_SPAWNERS_any] <- apply(
  X = all_areas_nuseds[!NATURAL_ADULT_SPAWNERS_any, c("Spawners","Broodstock","Removals")],
  MARGIN = 1, 
  FUN = sum, 
  na.rm = TRUE
)

all_areas_nuseds$Source[!NATURAL_ADULT_SPAWNERS_any] <- apply(
  X = all_areas_nuseds[!NATURAL_ADULT_SPAWNERS_any,c("SpawnersSource","BroodstockSource","RemovalsSource")], 
  MARGIN = 1, 
  FUN = function(x){
    paste(na.omit(x),collapse=" + ")}
)

# Set as NA rather than zero if no info in any column (the na.rm = T above produced)
# 0s when only NAs were available).
allNAs <- apply(
  X = all_areas_nuseds[!NATURAL_ADULT_SPAWNERS_any, c("Spawners","Broodstock","Removals")],
  MARGIN = 1, 
  FUN = function(x){all(is.na(x))}
) 
all_areas_nuseds$Returns[!NATURAL_ADULT_SPAWNERS_any][allNAs] <- NA

# Use TOTAL_RETURN_TO_RIVER if we still don't have a value
returns_any <- !is.na(all_areas_nuseds$Returns)
TOTAL_RETURN_TO_RIVER_any <- !is.na(all_areas_nuseds$TOTAL_RETURN_TO_RIVER)
toReplace <- !returns_any & TOTAL_RETURN_TO_RIVER_any
all_areas_nuseds$Returns[toReplace] <- all_areas_nuseds$TOTAL_RETURN_TO_RIVER[toReplace]
all_areas_nuseds$Source[toReplace] <- "TOTAL_RETURN_TO_RIVER"
```


```{r, include=FALSE, warning=FALSE}
#'* Determine "MAX_ESTIMATE" in NUSEDS *

#' MAX_ESTIMATE is the maximum estimate of all these fields:
var_in_MAX_ESTIMATE <- c("NATURAL_ADULT_SPAWNERS", 
                         "NATURAL_JACK_SPAWNERS", 
                         "NATURAL_SPAWNERS_TOTAL", 
                         "ADULT_BROODSTOCK_REMOVALS", 
                         "JACK_BROODSTOCK_REMOVALS",
                         "TOTAL_BROODSTOCK_REMOVALS",    
                         "OTHER_REMOVALS", 
                         "TOTAL_RETURN_TO_RIVER")

all_areas_nuseds$MAX_ESTIMATE <- apply(all_areas_nuseds[,var_in_MAX_ESTIMATE], 1,
                                       max, na.rm = TRUE)

# Replace infinite values by NA
all_areas_nuseds$MAX_ESTIMATE[is.infinite(all_areas_nuseds$MAX_ESTIMATE)] <- NA
```

We create the column `MAX_ESTIMATE` which is the maximum value of the fish count columns:

```{r,echo=FALSE}
var_in_MAX_ESTIMATE
```


# Fixes on NUSEDS and CUSS

```{r, include=F}
all_areas_nuseds_all <- all_areas_nuseds
nrow(all_areas_nuseds_all) # 412492

conservation_unit_system_sites_all <- conservation_unit_system_sites
nrow(conservation_unit_system_sites_all) # 7145
```

## Fix: coordinates of certain locations in CUSS

There are multiple locations in **CUSS** that have different `SYSTEM_SITE` and `GFE_ID` but exactly the same geographic coordinates. This is because the coordinates are not defined as the survey location but the "`r fields_def$cu_system_sites$X_LONGT`". There can be large distances between the coordinates in CUSS and the real survey locations for large water bodies. We consequently manually update the coordinates of certain of these locations.

```{r, include=F}
#' There are multiple locations in conservation_unit_system_sites that have 
#' different names and GFE_ID but exactly the same geographic coordinates. 
#' This causes an issue in the next data processing process when trying to 
#' provide streamid for the PSE.
#' The goal is to estimate the coordinates of the locations by hand using 
#' - google map
#' - https://maps.gov.bc.ca/ess/hm/imap4m

#' TODO: export the file manually once and then import it in future (cf. Population
#' meeting Sep 11 2024)

#' Note: the coordinates do not correspond to the survey location but the mouth
#' or centroid of the water body. But that causes a problem for large rivers.
conservation_unit_system_sites$X_LONGT <- round(conservation_unit_system_sites $X_LONGT,6)
conservation_unit_system_sites$Y_LAT <- round(conservation_unit_system_sites $Y_LAT,6)

# Find the coordinates of all the GFE_IDs
locations <- unique(conservation_unit_system_sites[,c("GFE_ID","X_LONGT","Y_LAT")])
nrow(locations) # 2333

# Get the duplicated coordinates and associated GFE_ID:
cond <- duplicated(locations[,c("X_LONGT","Y_LAT")])
coord_duplicated <- locations[,c("X_LONGT","Y_LAT")][cond,]
nrow(coord_duplicated) # 21

# Return these locations with SYSTEM_SITE
locations_duplicated <- NULL
for(r in 1:nrow(coord_duplicated)){
  cond <- conservation_unit_system_sites$X_LONGT == coord_duplicated[r,"X_LONGT"] &
  conservation_unit_system_sites$Y_LAT == coord_duplicated[r,"Y_LAT"]
  out <- unique(conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")])
  locations_duplicated <- rbind(locations_duplicated,out)
} 
locations_duplicated <- unique(locations_duplicated)
nrow(locations_duplicated) # 41

# Sort the dataset and group per coordinates (same letter for same coordinates)
locations_duplicated <- locations_duplicated_group_fun(locations_duplicated)
rownames(locations_duplicated) <- NULL
```

There are `r nrow(coord_duplicated)` unique coordinates with multiple `SYSTEM_SITE` and `GFE_ID` (n = `r nrow(locations_duplicated)`). We group locations with identical coordinates and for each of the group (identified with a letter in the table below), we manually modify the coordinates of the locations relatively to each other using `SYSTEM_SITE`:

```{r, echo=FALSE}
locations_duplicated[,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT","group")]
```

```{r, include=FALSE}
i <- 0
```

For group `r LETTERS[i+1]`:

```{r, echo = F}
# Fill the coordinate appropriately in each case:
i <- 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
X_Y <- c(51.344756,-119.797289)
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter

i_toChange <- 2
# not sure where the channel so I picked a location a little bit above the creek mouth
X_Y <- c(49.090741,-121.531078)  
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 1
X_Y <- c(49.107077, -121.636804)  #
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
# could not check if the creek is called Hawkins
X_Y <- c(49.169178, -122.191740)  
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
# could not found the beach so I picked a location just beside it
X_Y <- c(52.720154, -120.867586)  
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
i_toChange <- 3
 # could not found the beach so I picked a location just beside it
X_Y <- c(52.746393, -120.837075) 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, include=F}
cond <- conservation_unit_system_sites$SYSTEM_SITE == "BAXTER BEACH"
cond <- conservation_unit_system_sites$SYSTEM_SITE == "BEAR BEACH - SHORE"
cond <- conservation_unit_system_sites$SYSTEM_SITE == "BETTY FRANK'S - SHORE"
cond <- conservation_unit_system_sites$SYSTEM_SITE %in% c("BAXTER BEACH",
                                                          "BEAR BEACH - SHORE",
                                                          "BETTY FRANK'S - SHORE")
conservation_unit_system_sites[cond,]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
X_Y <- c(49.740213, -122.147390)  # 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, include=F}
cond <- conservation_unit_system_sites$SYSTEM_SITE == "LILLOOET RIVER"
conservation_unit_system_sites[cond,]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 1
# moved to CAYOOSH CREEK's mouth
X_Y <- c(50.680016, -121.929476) 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
# moved north a little bit
X_Y <- c(49.626847, -122.671116) 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
X_Y <- c(49.111242, -123.168505)  # just besid it 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
X_Y <- c(51.745035, -122.413504)  # just above it 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
# moved to the cross between the two rivers
X_Y <- c(49.294603, -124.879074)  
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
X_Y <- c(49.201198, -125.512450)  # placed it above
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 1
X_Y <- c(54.445124, -125.458809)  # moved above the weir
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 1
X_Y <- c(52.378979, -126.581766)  # no idea where these two creeks are exactly
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, include=F}
cond <- conservation_unit_system_sites$SYSTEM_SITE == "BETTY FRANK'S - SHORE"
cond <- conservation_unit_system_sites$SYSTEM_SITE %in% c("FORESTRY CREEK",
                                                          "MARTY'S CREEK")
conservation_unit_system_sites[cond,]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
X_Y <- c(50.342682, -127.437795)  # I don't know what is the difference between "creek" and "system"
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
X_Y <- c(55.081340, -125.560056)  # 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 2
X_Y <- c(54.816010, -126.163338)  # 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 1
X_Y <- c(52.225501, -127.598108)  # moved it just a little nord
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 1
X_Y <- c(52.044541, -128.068576)  # 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

For group `r LETTERS[i+1]`:

```{r, echo=F}
i <- i + 1
letter <- unique(locations_duplicated$group)[i]
cond <- locations_duplicated$group == letter
i_toChange <- 1
X_Y <- c(52.877146, -132.000700)  # 
locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
```

The fields `X_LONGT` and `Y_LAT` are updated in CUSS, and the new field `coordinates_changed` is added to indicate which locations are concerned.

```{r, include=F}
# Replace these values in CUSS
conservation_unit_system_sites$coordinates_changed <- F

for(l in unique(locations_duplicated$group)){
  # l <- unique(locations_duplicated$group)[1]
  cond_l <- locations_duplicated$group == l & !is.na(locations_duplicated$Y_LAT_new)
  GFE_ID <- locations_duplicated$GFE_ID[cond_l]
  SYSTEM_SITE <- locations_duplicated$SYSTEM_SITE[cond_l]
  Y_LAT_new <- locations_duplicated$Y_LAT_new[cond_l]
  X_LONGT_new <- locations_duplicated$X_LONGT_new[cond_l]
  
  for(i in 1:length(GFE_ID)){
    cond_cuss <- conservation_unit_system_sites$GFE_ID == GFE_ID[i] & 
      conservation_unit_system_sites$SYSTEM_SITE == SYSTEM_SITE[i]
    
    conservation_unit_system_sites$Y_LAT[cond_cuss] <- Y_LAT_new[i]
    conservation_unit_system_sites$X_LONGT[cond_cuss] <- X_LONGT_new[i]
    conservation_unit_system_sites$coordinates_changed[cond_cuss] <- T
  }
}

# Check if there is no more duplicated coordinates
locations <- unique(conservation_unit_system_sites [,c("GFE_ID","X_LONGT","Y_LAT")])
nrow(locations) # 2333
```

```{r}
# check is there still are different GFE_IDs with same coordinates:
coord_duplicated <- locations[,c("X_LONGT","Y_LAT")][duplicated(locations[,c("X_LONGT","Y_LAT")]),]
nrow(coord_duplicated) # 0
```

## Remove the IndexId & GFE_ID time series in NUSEDS with only NAs and/or 0s

```{r, include=FALSE}

nrow_before <- nrow(all_areas_nuseds)

# Use package parallel To optimize the (take up to 20 minutes otherwise)
# TEMPORARY: to comment out when done (takes a bit of time)
# detectCores()
# detectCores(logical = FALSE)
# cores_nb <- 10
# all_areas_nuseds <- remove_series_nodata_nuseds_parallel_fun(all_areas_nuseds = all_areas_nuseds,
#                                                              zeros_too = remove_timeSeries_zeros_too, # to consider 0s as well
#                                                              cores_nb = cores_nb)

# TEMPORARY: to save time, delete
# write.csv(all_areas_nuseds,paste0(wd_data,"/all_areas_nuseds_noNA0s_TEMP.csv"),
#           row.names = F)
all_areas_nuseds <- read.csv(paste0(wd_data,"/all_areas_nuseds_noNA0s_TEMP.csv"),
                             header = T)

nrow(all_areas_nuseds) # 309647

nrow_after <- nrow(all_areas_nuseds)
```

This procedure removes `r nrow_before - nrow_after` rows in **NUSEDS**, corresponding to `r round((nrow_before - nrow_after)/nrow_before*100,1)`% of the original dataset.

```{r, include = F}
# Record the series that were removed and why:
IndexId_GFE_ID_all <- unique(all_areas_nuseds_all[,c("IndexId","GFE_ID")])
nrow(IndexId_GFE_ID_all) # 11553

IndexId_GFE_ID <- unique(all_areas_nuseds[,c("IndexId","GFE_ID")])
nrow(IndexId_GFE_ID) # 7062

IndexId_GFE_ID_all <- paste(IndexId_GFE_ID_all$IndexId,IndexId_GFE_ID_all$GFE_ID,sep = "&")
IndexId_GFE_ID <- paste(IndexId_GFE_ID$IndexId,IndexId_GFE_ID$GFE_ID,sep = "&")

IndexId_GFE_ID_removed_c <- IndexId_GFE_ID_all[! IndexId_GFE_ID_all %in% IndexId_GFE_ID]
length(IndexId_GFE_ID_removed_c) # 4491
IndexId_GFE_ID_removed <- data.frame(IndexId = rep(NA,length(IndexId_GFE_ID_removed_c)),
                                     GFE_ID = rep(NA,length(IndexId_GFE_ID_removed_c)))

IndexId_GFE_ID_removed$IndexId <- sapply(X = IndexId_GFE_ID_removed_c, FUN = function(s){
  # s <- IndexId_GFE_ID_removed[1]
  return(strsplit(x = s, split = "&")[[1]][1])
  })

IndexId_GFE_ID_removed$GFE_ID <- sapply(X = IndexId_GFE_ID_removed_c, FUN = function(s){
  # s <- IndexId_GFE_ID_removed[1]
  return(strsplit(x = s, split = "&")[[1]][2])
})


if(remove_timeSeries_zeros_too){
  comment <- "Only NAs and/or 0s for MAX_ESTIMATE"
}else{
  comment <- "Only NAs for MAX_ESTIMATE"
}

removed_all <- IndexId_GFE_ID_removed
removed_all$dataset <- "NUSEDS"
removed_all$comment <- comment

# check
# i <- 3243
# plot_IndexId_GFE_ID_fun(IndexIds = removed_all$IndexId[i],
#                         GFE_IDs = removed_all$GFE_ID[i],
#                         all_areas_nuseds = all_areas_nuseds_all)
nrow(removed_all) # 4491
```

The data removed concerns `r nrow(removed_all)` time series, which are referenced in `removed_all`:

```{r, echo=FALSE}
head(removed_all)
```


Note that we do not remove these series in CUSS at this stage because they could be alternative series for the series in NUSEDS that do not appear in CUSS. It is only once series in NUSEDS absent in CUSS were found alternative series for, that we remove series in CUSS that have only NAs and/or 0s in NUSEDS.


## Fix time series in CUSS that are not in NUSEDS

Look for each time series in **CUSS** (i.e., unique `IndexId` & `GFE_ID` association) and:

1) check if there are `IndexId` associated to multiple locations (i.e., `GFE_ID`); if yes: trouble shoot manually because this should not happen: `IndexId` should be associated to one unique location.
      
2) else look if there is a time series with the same `IndexId` & `GFE_ID` in **NUSEDS**; if yes: all good :-)

3) else: that could be due to the wrong attribution of either (i) the `IndexId` or (ii) the `GFE_ID`. The rest of the code looks for potential alternative series in **NUSEDS** with either a different `IndexId` (but with the same species) or a different `GFE_ID`. Alternative series identified **NOT present in CUSS** are kept, the ones present are not considered.

The procedure returns a simple data frame with the `IndexId` & `GFE_ID` series concerned and associated comment and eventual potential alternative series that have to be checked manually after:

```{r, include=FALSE}

# 
# TEMPORARY: to comment out when done (takes a bit of time)
# cores_nb <- 10
# trackRecord <- cuss_nuseds_match_parallel_fun(conservation_unit_system_sites = conservation_unit_system_sites,
#                                               all_areas_nuseds = all_areas_nuseds, 
#                                               cores_nb = cores_nb)

# TEMPORARY: to save time, delete
# write.csv(trackRecord,paste0(wd_data,"/trackRecord_TEMP.csv"), row.names = F)
trackRecord <- read.csv(paste0(wd_data,"/trackRecord_TEMP.csv"), header = T)

nrow(trackRecord) # 7145

# Number of time series present in CUSS but not in NUSEDS:
cond <- trackRecord$in_nused == "no"
sum(cond) # 259

head(trackRecord[cond,])

# check the series related to different comments:
unique(trackRecord$comment[cond])
```

```{r, echo=FALSE}
cond <- trackRecord$in_nused == "no"
d <- trackRecord[cond,]
rownames(d) <- NULL
head(d)
```

There are `r sum(cond)` out of `r nrow(trackRecord)` time series in **CUSS** that are not present in **NUSEDS** (i.e., `r round(sum(cond)/nrow(trackRecord)*100,1)`%), and the vast majority of them do not have an alternative series in **NUSEDS**:

```{r}
table(trackRecord$comment[cond])
```

### Alternative series present

The goal here is to go over all the cases where alternative series are available. The title of the figures below shows the **focal series** that is in **CUSS** but not in **NUSEDS**. The series on the top left corner are potential **alternative series** (i.e., they are present in **NUSEDS** but not in **CUSS**).

```{r}
comment <- "Alternative series:"
trackRecord_cuss_alternative <- trackRecord[grepl(comment,trackRecord$comment),]
```

```{r, echo=FALSE}
rownames(trackRecord_cuss_alternative) <- NULL
nrow(trackRecord_cuss_alternative) # 4
trackRecord_cuss_alternative
```

```{r, include=F}
r <- 1
d <- trackRecord_cuss_alternative[r,,drop = F]
series_alternative <- d$comment
series_alternative <- gsub("Alternative series: ","",series_alternative)
series_alternative <- strsplit(series_alternative, split = ", ")[[1]]
series_alternative <- strsplit(series_alternative," & ")

iids <- sapply(X = series_alternative, function(c){c[1]})
gfeids <- sapply(X = series_alternative, function(c){c[2]})

d <- data.frame(IndexId = iids,
                GFE_ID = as.numeric(gfeids))

d

series_alternative <- paste(d$IndexId,"& GFE_ID =",d$GFE_ID)
series_focal <- paste0(trackRecord_cuss_alternative$IndexId[r]," & GFE_ID = ",
                      trackRecord_cuss_alternative$GFE_ID[r])
```

```{r, echo=FALSE}
#' Note: the title of the figure shows the focal series that is in CUSS but not 
#' in NUSEDS. The series on the top left corner are potential alternative series,
#' i.e. they are present in NUSEDS but not in CUSS.
main <- paste0("Alternative series for ",series_focal)
plot_IndexId_GFE_ID_fun(IndexIds = d$IndexId, 
                        GFE_IDs = d$GFE_ID, 
                        all_areas_nuseds = all_areas_nuseds_all, 
                        main = main)
```

The focal **CUSS** time series `r series_focal` corresponds to the `CU_NAME`:

```{r, echo = F}
cond <- conservation_unit_system_sites$IndexId %in% c("CN_46842","CN_46841")
unique(conservation_unit_system_sites$CU_NAME[cond])
```

The two alternative time series are noted as two different runs, according to **NUSEDS**'s `POPULATION`:

```{r,echo=F}
cond <- all_areas_nuseds$IndexId %in% c("CN_46842","CN_46841")
unique(all_areas_nuseds$POPULATION[cond])
```

```{r,include=F}
cond <- conservation_unit_system_sites$GFE_ID == as.numeric(gfeids[2])
Y_LAT_focal <- conservation_unit_system_sites$Y_LAT[cond] |> unique()
X_LONGT_focal <- conservation_unit_system_sites$X_LONGT[cond] |> unique()

cond <- conservation_unit_system_sites$GFE_ID == as.numeric(gfeids[1])
Y_LAT <- conservation_unit_system_sites$Y_LAT[cond] |> unique()
X_LONGT <- conservation_unit_system_sites$X_LONGT[cond] |> unique()

# c(Y_LAT_focal,X_LONGT_focal)
# c(Y_LAT,X_LONGT)

pt_focal <- SpatialPoints(coords = data.frame(x = X_LONGT_focal, y = Y_LAT_focal), 
                          proj4string = CRS("+proj=longlat +datum=WGS84"))
pt_alternative <- SpatialPoints(coords = data.frame(x = X_LONGT, y = Y_LAT), 
                                proj4string = CRS("+proj=longlat +datum=WGS84"))

dist <- spDists(x = pt_focal,y = pt_alternative, longlat = T) # distance in km
# spDists(x = pt_focal,y = pt_alternative, longlat = F) # Euclidian distance in ???
dist <- round(as.numeric(dist),2)
```

The distance between the two locations (i.e., the two `GFE_ID`) is `r dist` km.

```{r, include=F}
#' TODO: replace CN_46842 & GFE_ID = 2463 and CN_46841 & GFE_ID = 285 by 
#' CN_46842 & GFE_ID = 285 in NUSEDS.

#' Conversation about merging them:
#' https://salmonwatersheds.slack.com/archives/CJ5RVHVCG/p1707929645199719?thread_ts=1707771319.134789&cid=CJ5RVHVCG 

removed <- data.frame(IndexId = c("CN_46842","CN_46841"),
                      GFE_ID = c(2463,285))
removed$dataset <- "NUSEDS"
removed$comment <- "Alternative series for CN_46842 & GFE_ID = 285"
removed_all <- rbind(removed_all,removed)

#' CN_46842 & GFE_ID = 2463 --> CN_46842 & GFE_ID = 285
#' --> change of GFE_ID:
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CN_46842",
                                                IndexId_alter = "CN_46842",
                                                GFE_ID_focal = 2463,
                                                GFE_ID_alter = 285,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

#' CN_46841 & GFE_ID = 285 --> CN_46842 & GFE_ID = 285
#' --> change IndexId
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CN_46841",
                                                IndexId_alter = "CN_46842",
                                                GFE_ID_focal = 285,
                                                GFE_ID_alter = 285,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
```

**Decision:** It was decided to merge the two time series `r paste(series_alternative, collapse = " and ")` to the series `r series_focal` in **NUSEDS** because there is only one timing for this Middle Fraser River (Spring 5-2) Chinook CU and the two series are complementary.


```{r, include=F}
r <- 2
d <- trackRecord_cuss_alternative[r,,drop = F]
series_alternative <- d$comment
series_alternative <- gsub("Alternative series: ","",series_alternative)
series_alternative <- strsplit(series_alternative, split = ", ")[[1]]
series_alternative <- strsplit(series_alternative," & ")

iids <- sapply(X = series_alternative, function(c){c[1]})
gfeids <- sapply(X = series_alternative, function(c){c[2]})

d <- data.frame(IndexId = iids,
                GFE_ID = gfeids)

series_alternative <- paste(d$IndexId,"& GFE_ID =",d$GFE_ID)
series_focal <- paste0(trackRecord_cuss_alternative$IndexId[r]," & GFE_ID = ",
                      trackRecord_cuss_alternative$GFE_ID[r])
```

```{r, echo=FALSE}
main <- paste0("Alternative series for ",series_focal)
plot_IndexId_GFE_ID_fun(IndexIds = d$IndexId, 
                        GFE_IDs = d$GFE_ID, 
                        all_areas_nuseds = all_areas_nuseds_all, 
                        main = main)
```

**Decision:** we remove series `r series_focal` from **CUSS** and `r series_alternative` from **NUSEDS**.

```{r,include=F}

#' TODO: we remove PKE_42409 & GFE_ID = 1490 from conservation_unit_system_sites
#' and PKE_54793433 & GFE_ID = 1490 from NUSEDS.
removed <- data.frame(IndexId = c("PKE_42409","PKE_54793433"),
                      GFE_ID = c(1490,1490))
removed$dataset <- c("CUSS","NUSEDS")
removed$comment <- c("Removed because not in NUSEDS and alternative series PKE_54793433 & GFE_ID = 1490 ahs only one data point as was removed",
                     "Only 1 data point(s) and not in CUSS")

removed_all <- rbind(removed_all,removed)

condition <- conservation_unit_system_sites$IndexId == removed$IndexId[1] &
  conservation_unit_system_sites$GFE_ID == removed$GFE_ID[1]
conservation_unit_system_sites[condition,]
conservation_unit_system_sites <- conservation_unit_system_sites[!condition,]
nrow(conservation_unit_system_sites) # 7144

condition <- all_areas_nuseds$IndexId == removed$IndexId[2] &
  all_areas_nuseds$GFE_ID == removed$GFE_ID[2]
all_areas_nuseds <- all_areas_nuseds[!condition,]
nrow(all_areas_nuseds) # 309637
```

```{r, include=F}
r <- 3
d <- trackRecord_cuss_alternative[r,,drop = F]
series_alternative <- d$comment
series_alternative <- gsub("Alternative series: ","",series_alternative)
series_alternative <- strsplit(series_alternative, split = ", ")[[1]]
series_alternative <- strsplit(series_alternative," & ")

iids <- sapply(X = series_alternative, function(c){c[1]})
gfeids <- sapply(X = series_alternative, function(c){c[2]})

d <- data.frame(IndexId = iids,
                GFE_ID = gfeids)

series_alternative <- paste(d$IndexId,"& GFE_ID =",d$GFE_ID)
series_focal <- paste0(trackRecord_cuss_alternative$IndexId[r]," & GFE_ID = ",
                      trackRecord_cuss_alternative$GFE_ID[r])
```

```{r, echo=FALSE}
main <- paste0("Alternative series for ",series_focal)
plot_IndexId_GFE_ID_fun(IndexIds = d$IndexId, 
                        GFE_IDs = d$GFE_ID, 
                        all_areas_nuseds = all_areas_nuseds, 
                        main = main)
```

These two locations are from the same river according the **CUSS**'s `SYSTEM_SITE`:

```{r,echo=F}
cond <- conservation_unit_system_sites$GFE_ID %in% c(2463,285)
unique(conservation_unit_system_sites$SYSTEM_SITE[cond])
```

```{r,include=F}
cond <- conservation_unit_system_sites$GFE_ID == 285
Y_LAT_focal <- conservation_unit_system_sites$Y_LAT[cond] |> unique()
X_LONGT_focal <- conservation_unit_system_sites$X_LONGT[cond] |> unique()

cond <- conservation_unit_system_sites$GFE_ID == 2463
Y_LAT <- conservation_unit_system_sites$Y_LAT[cond] |> unique()
X_LONGT <- conservation_unit_system_sites$X_LONGT[cond] |> unique()

# c(Y_LAT_focal,X_LONGT_focal)
# c(Y_LAT,X_LONGT)

pt_focal <- SpatialPoints(coords = data.frame(x = X_LONGT_focal, y = Y_LAT_focal), 
                          proj4string = CRS("+proj=longlat +datum=WGS84"))
pt_alternative <- SpatialPoints(coords = data.frame(x = X_LONGT, y = Y_LAT), 
                                proj4string = CRS("+proj=longlat +datum=WGS84"))

dist <- spDists(x = pt_focal,y = pt_alternative, longlat = T) # distance in km
# spDists(x = pt_focal,y = pt_alternative, longlat = F) # Euclidian distance in ???
dist <- round(as.numeric(dist),2)
```

The distance between the two locations is `r dist` km (same as before).

```{r,include=F}
#' TODO: replace CO_46835 & 2463 by CO_46835 & 285 in NUSEDS.
#' --> change GFE_ID:

removed <- data.frame(IndexId = c("CO_46835"),
                      GFE_ID = 2463)
removed$dataset <- "NUSEDS"
removed$comment <- "Alternative series for CO_46835 & GFE_ID = 285"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46835",
                                                IndexId_alter = "CO_46835",
                                                GFE_ID_focal = 2463,
                                                GFE_ID_alter = 285,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
```

**Decision:** Replace `r paste(series_alternative, collapse = " and ")` by `r series_focal` in **NUSEDS**.

```{r,include=FALSE}
r <- 4
d <- trackRecord_cuss_alternative[r,,drop = F]
series_alternative <- d$comment
series_alternative <- gsub("Alternative series: ","",series_alternative)
series_alternative <- strsplit(series_alternative, split = ", ")[[1]]
series_alternative <- strsplit(series_alternative," & ")

iids <- sapply(X = series_alternative, function(c){c[1]})
gfeids <- sapply(X = series_alternative, function(c){c[2]})

d <- data.frame(IndexId = iids,
                GFE_ID = gfeids)

series_alternative <- paste(d$IndexId,"& GFE_ID =",d$GFE_ID)
series_focal <- paste0(trackRecord_cuss_alternative$IndexId[r]," & GFE_ID = ",
                      trackRecord_cuss_alternative$GFE_ID[r])
```

```{r, echo=FALSE}
main <- paste0("Alternative series for ",series_focal)
plot_IndexId_GFE_ID_fun(IndexIds = d$IndexId, 
                        GFE_IDs = d$GFE_ID, 
                        all_areas_nuseds = all_areas_nuseds, 
                        main = main)
```

The two time series have the same `CU_NAME` in **CUSS**:

```{r,echo=F}
sapply(X = c("SX_7763","SX_47954"),function(iid){
  cond <- conservation_unit_system_sites$IndexId == iid
  return(conservation_unit_system_sites$CU_NAME[cond])
})
```

```{r,include=F}
#' TODO: replace SX_47954 & 21 by SX_7763 & 21 in NUSEDS.
#' --> change IndexId
removed <- data.frame(IndexId = c("SX_47954"),
                      GFE_ID = 21)
removed$dataset <- "NUSEDS"
removed$comment <- "Alternative series for SX_7763 & GFE_ID = 21"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "SX_47954",
                                                IndexId_alter = "SX_7763",
                                                GFE_ID_focal = 21,
                                                GFE_ID_alter = 21,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
```

**Decision:** Replace `r paste(series_alternative, collapse = " and ")` by `r series_focal` in **NUSEDS**.


###  Alternative series not present in NUSEDS

The goal is to remove these `InsexId` & `GFE_ID` references from **CUSS** and to specify if they were simply not present in the orginal **NUSEDS** or only contained NAs and/or 0s.

```{r}
comment <- "There is no alternative series in NUSEDS"
trackRecord_cuss_noAlernative <- trackRecord[grepl(comment,trackRecord$comment),]
```

```{r, echo=FALSE}
rownames(trackRecord_cuss_noAlernative) <- NULL
nrow(trackRecord_cuss_noAlernative) # 254
head(trackRecord_cuss_noAlernative[,c("IndexId","GFE_ID","in_cuss","in_nused","comment")])
```

```{r, include=F}
for(r in 1:nrow(trackRecord_cuss_noAlernative)){
  # r <- 1
  iid <- trackRecord_cuss_noAlernative$IndexId[r]
  gfeid <- trackRecord_cuss_noAlernative$GFE_ID[r]
  
  # check if the series already exists in removed_all
  cond <- removed_all$IndexId == iid & removed_all$GFE_ID == gfeid
  if(nrow(removed_all[cond,]) > 0){ # edit removed_all
    removed_all$dataset[cond] <- "both"   # because if the reference of the series is already there is because it was removed from NUSEDS
    print(paste("Series",iid,"-",gfeid,"was in NUSEDS with only NAs and/or 0s"))
    
  }else{ # add row to removed_all
    removed <- data.frame(IndexId = iid,
                          GFE_ID = gfeid,
                          dataset = "CUSS")
    removed$comment <- "Not in NUSEDS and no alternative series"
    removed_all <- rbind(removed_all,removed)
    # print(paste("Series",iid,"-",gfeid,"was not nuseds"))
  }
  
  # remove series from conservation_unit_system_sites
  cond <- conservation_unit_system_sites$IndexId == iid &
    conservation_unit_system_sites$GFE_ID == gfeid
  conservation_unit_system_sites <- conservation_unit_system_sites[!cond,]
}

nrow(conservation_unit_system_sites) # 6890


# all but one of the series are in all_areas_nuseds_all
cond <- removed_all$dataset == "both"
sum(cond) # 253 (vs. 254)

```

`r sum(cond)` of the `r nrow(trackRecord_cuss_noAlernative)` `InsexId` & `GFE_ID` references were removed previously from **NUSEDS** because they contained only NAs and/or 0s. Only the following reference was not in **NUSEDS** initially:

```{r, include=FALSE}
# the only series in CUSS not in all_areas_nuseds_all
cond <- grepl("Not in NUSEDS and no alternative series",removed_all$comment)
removed_all[cond,]
# IndexId GFE_ID                        dataset                                           comment
# SX_2167	150	CUSS	Not in NUSEDS and no alternative series

IndexId <- removed_all$IndexId[cond]
GFE_ID <- removed_all$GFE_ID[cond]
```

```{r, echo=F}
cond <- conservation_unit_system_sites_all$IndexId == IndexId & 
  conservation_unit_system_sites_all$GFE_ID == GFE_ID

show <- conservation_unit_system_sites_all[cond,c("GFE_ID","SYSTEM_SITE","SPECIES_QUALIFIED","CU_NAME","FULL_CU_IN")] # "UPPER FRASER"
rownames(show) <- NULL
show
```

### Multiple GFE_IDs for a same IndexId in CUSS

There should not be any `InsexId` associated to multiple `GFE_ID` (it is a MANY TO ONE relationship).

```{r}
comment <- "In CUSS: there are multiple GFE_IDs for"
trackRecord_cuss_multi_fgeid <- trackRecord[grepl(comment,trackRecord$comment),]
```

This happens for `r length(unique(trackRecord_cuss_multi_fgeid$IndexId))` populations:

```{r, echo=FALSE}
rownames(trackRecord_cuss_multi_fgeid) <- NULL
trackRecord_cuss_multi_fgeid
```

```{r, echo=FALSE}
#' Case with CN_7479:
#'    -  series CN_7479 & GF_ID = 133 is not in all_areas_nuseds_all 
#'    (nor in NUSEDS) as shown by its absence in the figure below.
#'    TODO: remove CN_7479 & GF_ID = 133 from CUSS
iid <- unique(trackRecord_cuss_multi_fgeid$IndexId)[1]
gfeids <- trackRecord_cuss_multi_fgeid$GFE_ID[1:2]

#' Note: series CN_7479 & GF_ID = 133 is not in NUSEDS, which is why it does not 
#' appear in the figure.
par(mar = c(4.5,4.5,.5,.5))
plot_IndexId_GFE_ID_fun(IndexIds = iid,
                        all_areas_nuseds = all_areas_nuseds)
```

The figure above only show the time series present in **NUSEDS**. The other time series is removed from **CUSS**.

```{r, include=FALSE}
cond <- conservation_unit_system_sites$IndexId == "CN_7479" & 
  conservation_unit_system_sites$GFE_ID == 133

conservation_unit_system_sites <- conservation_unit_system_sites[!cond,]
nrow(conservation_unit_system_sites) # 6889

removed <- data.frame(IndexId = "CN_7479",
                      GFE_ID = 133,
                      dataset = "conservation_unit_system_sites")
removed$comment <- "Not in NUSEDS and no alternative series"
removed_all <- rbind(removed_all,removed)
```


```{r, echo=FALSE}
#' Case with SX_45525:
#' - there is no "Nadina channel" in streamlocationids (the red series) and seems
#' that the abundances were summed in the PSE.
#' TODO: create a new row in streamlocationids for the red series.
iid <- unique(trackRecord_cuss_multi_fgeid$IndexId)[2]
gfeids <- trackRecord_cuss_multi_fgeid$GFE_ID[trackRecord_cuss_multi_fgeid$IndexId == iid]
par(mar = c(4.5,4.5,.5,.5))
plot_IndexId_GFE_ID_fun(IndexIds = iid, 
                        all_areas_nuseds = all_areas_nuseds_all)

# add the WATERBODY associated with the GFE_ID:
POP_WB <- lapply(X = c(2444,303), FUN = function(x){
  cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == x
  pop <- unique(all_areas_nuseds$POPULATION[cond])
  wb <-  unique(all_areas_nuseds$WATERBODY[cond])
  out <- data.frame(POPULATION = pop,
                    WATERBODY = wb)
  return(out)
})
POP_WB <- do.call(rbind,POP_WB)
legend("top",c("WATERBODY:",POP_WB$WATERBODY),bty = 'n')
#legend("topright",c("POPULATION:",GFE_IDs),bty = 'n')

cond <- conservation_unit_system_sites$IndexId == iid
CU_NAME <- conservation_unit_system_sites$CU_NAME[cond]
```

```{r, include=FALSE}
# internal checks
# cond <- grepl("[N|n]adina",streamlocationids$sys_nm) & grepl("[S|s]ockeye",streamlocationids$species_name)
# streamlocationids[cond,]

# they have the same CU_NAME (as expected because it is the same IndexId)
sapply(X = c(2444,303),FUN = function(x){
  cond <- conservation_unit_system_sites$IndexId == iid &
    conservation_unit_system_sites$GFE_ID == x
  out <- conservation_unit_system_sites$CU_NAME[cond]
  return(out)
})

# check coordinates --> there are different
sapply(X = c(2444,303),FUN = function(x){
  cond <- conservation_unit_system_sites$IndexId == iid &
    conservation_unit_system_sites$GFE_ID == x
  out <- conservation_unit_system_sites[cond,c("Y_LAT","X_LONGT")]
  return(out)
})

# check pop size for the blue (to see if correspond to values in the PSE)
cond <- all_areas_nuseds$IndexId == "SX_45525" & all_areas_nuseds$GFE_ID == 303
all_areas_nuseds[cond,c("Year","MAX_ESTIMATE")][order(all_areas_nuseds[cond,c("Year")]),]
```

These two time series of this CU (`CU_NAME` = `r CU_NAME`) should have a different `IndexId` (i.e. `POP_ID`). We keep them as is and do not make any change to **NUSEDS** and **CUSS**.


```{r, include=FALSE}
#' TODO: check if the time series below appears on the PSE now --> IT IS
# cond <- conservation_unit_system_sites$GFE_ID == 2444
# SYSTEM_SITE <- conservation_unit_system_sites$SYSTEM_SITE[cond]
# toAdd <- data.frame(IndexId = "SX_45525",
#                     GFE_ID = 2444,
#                     # SYSTEM_SITE = SYSTEM_SITE,
#                     dataset = "streamlocationids",
#                     CU_NAME = "NADINA/FRANCOIS-EARLY SUMMER TIMING",
#                     comment = "In both CUSS and NUSEDS but not in the PSE; but series SX_45525 - 303 is.")
# 
# added_all <- toAdd
```


## Fix populations in NUSEDS that are not in CUSS

The goal is to look for each `IndexId` & `GFE_ID` series in **NUSEDS** that are not in **CUSS** and to:

1) Remove series with < 4 data points (too much work for not enough data points; eventually rescue this data in future)

2) Look if there are alternative series in **NUSEDS** that are also present in **CUSS**

- if not, add the `IndexId` & `GFE_ID` reference in **CUSS**

- if yes, see if the alternative series can be merged; if not, add the `IndexId` & `GFE_ID` reference to **CUSS**


```{r, include=FALSE}
series_nuseds <- paste(all_areas_nuseds$IndexId,
                       all_areas_nuseds$GFE_ID,sep = "&")
series_nuseds <- unique(series_nuseds)
length(series_nuseds) # 7060

series_cuss <- paste(conservation_unit_system_sites$IndexId,
                     conservation_unit_system_sites$GFE_ID,sep = "&")
series_cuss <- unique(series_cuss)
length(series_cuss) # 6889

#' Now all the series in CUSS are in all_areas_nuseds.
series_cuss[! series_cuss %in% series_nuseds]

# Number of series in NUSEDS not in CUSS:
series_Nuseds_noCuss <- series_nuseds[! series_nuseds %in% series_cuss]
series_Nuseds_noCuss <- series_Nuseds_noCuss[order(series_Nuseds_noCuss)]
n <- length(series_Nuseds_noCuss) # 171
```

There are `r n` `IndexId` & `GFE_ID` references in **NUSEDS** that are not present in **CUSS**, for instance:

```{r, include=FALSE}
iids <- sapply(X = series_Nuseds_noCuss,FUN = function(s){
  return(strsplit(s,"&")[[1]][1])
})

gfeids <- sapply(X = series_Nuseds_noCuss,FUN = function(s){
  return(strsplit(s,"&")[[1]][2])
})

trackRecord_nuseds <- data.frame(IndexId = iids,
                                 GFE_ID = gfeids)
trackRecord_nuseds$nb_dataPt <- NA
trackRecord_nuseds$alternative_IndexId <- NA
trackRecord_nuseds$alternative_GFE_ID <- NA
trackRecord_nuseds$alternative_IndexId_track <- NA # to retain the alternative IndexId not retained because series is not in CUSS
trackRecord_nuseds$alternative_GFE_ID_track <- NA # to retain the alternative GFE_ID not retained because series is not in CUSS
# trackRecord_nuseds$only_0s <- NA
rownames(trackRecord_nuseds) <- NULL

for(i in 1:nrow(trackRecord_nuseds)){
  # i <- 35
  #' 2. is there a GFE_ID + species in cuss
  iid <- trackRecord_nuseds$IndexId[i]
  speciesAcro <- strsplit(iid,split = "_")[[1]][1]
  gfeid <- trackRecord_nuseds$GFE_ID[i]
  
  # plot_IndexId_GFE_ID_fun(IndexIds = iid,
  #                         all_areas_nuseds = all_areas_nuseds)
  # legend("topright", paste("Series not in CUSS"), bty = 'n')
  
  # Find the number of data points
  cond <- all_areas_nuseds$IndexId == iid &
    all_areas_nuseds$GFE_ID == gfeid
  nuseds_cut <- all_areas_nuseds[cond,]
  max_esti <- nuseds_cut$MAX_ESTIMATE
  trackRecord_nuseds$nb_dataPt[i] <- sum(!is.na(nuseds_cut$MAX_ESTIMATE))
  # max_esti <- max_esti[!is.na(max_esti)]
  # if(all(max_esti == 0)){
  #   trackRecord_nuseds$only_0s[i] <- T
  # }
  
  #' 1) Look in NUSEDS for alternative series that are in CUSS with the same IndexId
  #' but different GFE_ID.
  cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID != gfeid
  nuseds_here <- all_areas_nuseds[cond,]
  
  alternative_GFE_ID <- c()
  alternative_GFE_ID_track <- c()
  
  # there is no alternative series in NUSEDS
  if(nrow(nuseds_here) == 0){
    alternative_GFE_ID <- "none"
    
  }else{
    
    # look if the these alternative series are in CUSS:
    gfeids <- unique(nuseds_here$GFE_ID)
    for(gfeid_i in gfeids){
      # gfeid_i <- gfeids[2]
      cond <- conservation_unit_system_sites$IndexId == iid &
        conservation_unit_system_sites$GFE_ID == gfeid_i
      
      # if the alternative series is in CUSS
      if(any(cond)){
        alternative_GFE_ID <- c(alternative_GFE_ID,
                                conservation_unit_system_sites$GFE_ID[cond])
        
      }else{ # in that case the alternative series has to be in trackRecord_nuseds
        cond <- trackRecord_nuseds$IndexId == iid &
          trackRecord_nuseds$GFE_ID == gfeid_i
        
        alternative_GFE_ID_track <- c(alternative_GFE_ID_track,
                                      trackRecord_nuseds$GFE_ID[cond])
      }
    }
    if(length(alternative_GFE_ID) == 0){
      alternative_GFE_ID <- "none"
    }
  }
  
  #' 2) Look in NUSEDS for alternative series that are in CUSS with the same GFE_ID 
  #' and species but different IndexId
  cond <- all_areas_nuseds$species_acronym_ncc == speciesAcro & 
    all_areas_nuseds$GFE_ID == gfeid &
    all_areas_nuseds$IndexId != iid
  nuseds_here <- all_areas_nuseds[cond,]
  
  alternative_IndexId <- c()
  alternative_IndexId_track <- c()
  
  # there is no alternative series in NUSEDS
  if(nrow(nuseds_here) == 0){
    alternative_IndexId <- "none"
    
  }else{
    # look if the these alternative series are in CUSS:
    iids <- unique(nuseds_here$IndexId)
    for(iid_i in iids){
      # iid_i <- iids[1]
      cond <- conservation_unit_system_sites$IndexId == iid_i &
        conservation_unit_system_sites$GFE_ID == gfeid
      
      # if the alternative series is in CUSS
      if(any(cond)){
        alternative_IndexId <- c(alternative_IndexId,
                                 conservation_unit_system_sites$IndexId[cond])
        
      }else{ # in that case the alternative series has to be in trackRecord_nuseds
        cond <- trackRecord_nuseds$IndexId == iid_i &
          trackRecord_nuseds$GFE_ID == gfeid
        
        alternative_IndexId_track <- c(alternative_IndexId_track,
                                       trackRecord_nuseds$IndexId[cond])
      }
    }
    if(length(alternative_IndexId) == 0){
      alternative_IndexId <- "none"
    }
  }
  trackRecord_nuseds$alternative_GFE_ID[i] <- paste(alternative_GFE_ID,collapse = " ; ")
  trackRecord_nuseds$alternative_GFE_ID_track[i] <- paste(alternative_GFE_ID_track,collapse = " ; ")
  trackRecord_nuseds$alternative_IndexId[i] <- paste(alternative_IndexId,collapse = " ; ")
  trackRecord_nuseds$alternative_IndexId_track[i] <- paste(alternative_IndexId_track,collapse = " ; ")
  # trackRecord_nuseds[i,]
}
#View(trackRecord_nuseds)
head(trackRecord_nuseds)
nrow(trackRecord_nuseds) # 171
rownames(trackRecord_nuseds) <- NULL
```

```{r, echo=FALSE}
head(trackRecord_nuseds[,c("IndexId","GFE_ID","nb_dataPt","alternative_IndexId","alternative_GFE_ID")])
```

### Remove series number of data points < 4

```{r, include=FALSE}
cond_3 <- trackRecord_nuseds$nb_dataPt < 4
trackRecord_nuseds_3 <- trackRecord_nuseds[cond_3,]
nrow(trackRecord_nuseds_3) # 94
```

There are `r nrow(trackRecord_nuseds_3)` populations removed because they have < 4 data points; for instance:

```{r, echo=FALSE}
i <- 94
par(mar = c(4.5,4.5,.5,.5))
plot_IndexId_GFE_ID_fun(IndexIds = trackRecord_nuseds_3$IndexId[i],
                        GFE_IDs = trackRecord_nuseds_3$GFE_ID[i],
                        all_areas_nuseds = all_areas_nuseds_all)
```

```{r, include = FALSE}

nrow_before <- nrow(all_areas_nuseds)

removed <- trackRecord_nuseds_3[,c("IndexId","GFE_ID")]
removed$dataset <- "all_areas_nuseds"
removed$comment <- paste("Only",trackRecord_nuseds_3$nb_dataPt,
                         "data point(s) and not in conservation_unit_system_sites")

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
nrow(all_areas_nuseds) # 308250

removed_all <- rbind(removed_all,removed)
nrow(removed_all) # 4593

nrow_after <- nrow(all_areas_nuseds)
```

The procedure removes `r nrow_before - nrow_after` rows in **NUSEDS**.


###  Alternative IndexId AND no alternative GFE_ID

The section concerns focal `IndexId` & `GFE_ID` time series in **NUSEDS** that are not in **CUSS** and for which there are alternative series in **CUSS** with the same `IndexId` but a different `GFE_ID`.  The goal is to compare the focal vs. the alternative time series and take the following actions:

- if the time series are 100% complementary: merge them (i.e., edit `IndexId` in **NUSEDS**)

- if the time series are 100% duplicated: remove the focal series in **NUSEDS**

- if the series are partially conflictual or if there are multiple potential alternative series: trubble shoot manually


```{r, include=FALSE}
cond <- trackRecord_nuseds$alternative_IndexId != "none" &
  trackRecord_nuseds$alternative_GFE_ID == "none" & 
  !cond_3
trackRecord_nuseds_iid <- trackRecord_nuseds[cond,]
```

There are `r nrow(trackRecord_nuseds_iid)` time series concerned: 

```{r, echo=FALSE}
show <- trackRecord_nuseds_iid[,c("IndexId","GFE_ID","nb_dataPt","alternative_IndexId")]
row.names(show) <- NULL
show
```

The figures below show for each of these cases the decision made. The figures also show the `CU_MAME` of focal and alternative `IndexId`. The `i` at the bottom left of each plot is used after to reference the figures when fixing time series manually. Several cases are set aside to be manually fixed after.


```{r, echo=FALSE, fig.width = 14, fig.height = 8}
removed <- removed_all[F,]

set_aside <- list()
count_set_aside <- 1
for(i in 1:nrow(trackRecord_nuseds_iid)){
  # i <- 1
  iid_focal <- trackRecord_nuseds_iid$IndexId[i]
  iid_alter <- strsplit(trackRecord_nuseds_iid$alternative_IndexId[i]," ; ")[[1]]
  gfeid <- trackRecord_nuseds_iid$GFE_ID[i]
  
  # compare the series
  cond <- all_areas_nuseds$IndexId == iid_focal & 
    all_areas_nuseds$GFE_ID == gfeid
  series_focal <- all_areas_nuseds$MAX_ESTIMATE[cond]
  names(series_focal) <- all_areas_nuseds$Year[cond]
  
  # 
  POPULATION_focal <- unique(all_areas_nuseds$POPULATION[cond])
  POPULATION_alter <- c()
  
  comparison_series <- data.frame(IndexId = iid_alter, 
                                  GFE_ID = gfeid)
  comparison_series$complementary <- NA
  comparison_series$duplicate <- NA
  comparison_series$conflict <- NA
  comparison_series$decision <- NA
  
  for(iid in iid_alter){
    # iid <- iid_alter[1]
    cond <- all_areas_nuseds$IndexId == iid & 
      all_areas_nuseds$GFE_ID == gfeid[1]
    series_comp <- all_areas_nuseds$MAX_ESTIMATE[cond]
    names(series_comp) <- all_areas_nuseds$Year[cond]
    comparison <- compare_series_fun(series_focal,series_comp,percentage = T)
    
    comparison_series$nb_dataPt[which(iid == iid_alter)] <- comparison$nb_dataPt
    comparison_series$complementary[which(iid == iid_alter)] <- comparison$complementary
    comparison_series$duplicate[which(iid == iid_alter)] <- comparison$duplicate
    comparison_series$conflict[which(iid == iid_alter)] <- comparison$conflict
    
    POPULATION_here <- unique(all_areas_nuseds$POPULATION[cond])
    POPULATION_alter <- c(POPULATION_alter,POPULATION_here)
  }
  
  removed_here <- NULL
  #' 1) If the series is 100% duplicated with another: REMOVE
  if(any(comparison_series$duplicate == 100)){
    
    cond <- comparison_series$duplicate == 100
    iid_replacement <- comparison_series$IndexId[cond]
    gfeid_replacement <- comparison_series$GFE_ID[cond]
    
    removed_here <- removed_all[1,]
    removed_here$IndexId <- iid_focal
    removed_here$GFE_ID <- gfeid
    removed_here$dataset <- "all_areas_nuseds"
    comment <- paste("Duplicate of series IndexId =",iid_replacement,"& GFE_ID =",
                     gfeid_replacement)
    removed_here$comment <- comment
    
    main <- "Removed because duplicated"
    
    #' Do the change in NUSEDS: only change the IndexId are related fields (not 
    #' the GFE_ID ones because here GFE_IDs are the same).
    all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                               toRemove = removed_here, 
                                               fields = c("IndexId","GFE_ID"))
    
    #' 2) if a series is 100 % compatible with one and only one alternative: MERGE
    #' If with more than one: set aside.
  }else if(any(comparison_series$complementary == 100)){
    
    if(sum(comparison_series$complementary == 100) == 1){
      cond <- comparison_series$complementary == 100
      iid_merge <- comparison_series$IndexId[cond]
      gfeid_merge <- comparison_series$GFE_ID[cond]
      
      # removed_here <- removed_all[1,]
      # removed_here$IndexId <- iid_focal
      # removed_here$GFE_ID <- gfeid
      # removed_here$dataset <- "all_areas_nuseds"
      # comment <- paste("Merged to series IndexId =",iid_merge,"& GFE_ID =",
      #                  gfeid_merge,"because 100% compatible")
      # removed_here$comment <- comment
      
      main <- paste("To merged to",iid_merge,"-",gfeid_merge)
      
    }else{
      set_aside[[count_set_aside]] <- comparison_series
      names(set_aside)[count_set_aside] <- paste("IndexId =",iid_focal,"& GFE_ID =",
                                                 gfeid)
      count_set_aside <- count_set_aside + 1
      main <-"Set aside all alternative series are 100% compatible"
    }
  }else{
    main <- "Set aside for now"
    set_aside[[count_set_aside]] <- comparison_series
    names(set_aside)[count_set_aside] <- paste("IndexId =",iid_focal,"& GFE_ID =",
                                               gfeid)
    count_set_aside <- count_set_aside + 1
    
  }
  
  #
  plot_IndexId_GFE_ID_fun(IndexIds = c(iid_focal,iid_alter),
                          GFE_IDs = rep(trackRecord_nuseds_iid$GFE_ID[i],
                                        length(iid_alter) + 1),
                          all_areas_nuseds = all_areas_nuseds_all, 
                          main = main)
  # legend("top",c("focal",rep("alterntive",length(POPULATION_alter))),col = NA,lwd = 1,bty = "n")
  # legend("topright",c(POPULATION_focal,POPULATION_alter),pch = NA, bty = "n")
  n1 <- c("focal",rep("alterntive",length(POPULATION_alter)))
  n2 <- c(POPULATION_focal,POPULATION_alter)
  legend("topright",paste(n1,n2, sep = " - "),pch = NA, bty = "n")
  legend("bottomleft",paste("i =",i),bty = "n")
  
  print(comparison_series)
  print("***")
  
  if(!is.null(removed_here)){
    removed <- rbind(removed,removed_here)
  }
}
```

We now assess the cases set aside.

```{r, include=FALSE}
i <- 1
#' Case with CN_3331 (i = 1): UNKNOWN TIMING
#' Temporal fields show contradictions.
#' TODO: remove because they cannot be attributed to either alternative series
iid <- c("CN_3331") # ,"CN_3334")
gfeid <- trackRecord_nuseds_iid$GFE_ID[trackRecord_nuseds_iid$IndexId == iid]
cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
unique(all_areas_nuseds[cond,c("START_DTT","END_DTT")]) # all year
unique(all_areas_nuseds[cond,c("STREAM_ARRIVAL_DT_FROM","STREAM_ARRIVAL_DT_TO")]) # spring
unique(all_areas_nuseds[cond,c("PEAK_SPAWN_DT_FROM","PEAK_SPAWN_DT_TO")]) # summer/fall
unique(all_areas_nuseds[cond,c("END_SPAWN_DT_FROM","END_SPAWN_DT_TO")])   # fall

# retain the POPULATION for the different IndexId
iida <- trackRecord_nuseds_iid$alternative_IndexId[trackRecord_nuseds_iid$IndexId == iid]
iida <- strsplit(x = iida, split = " ; ")[[1]]
show <- data.frame(IndexId =  c(iid,iida), 
                   type = c("focal",rep("alternative",length(iida))))

show$POPULATION <- sapply(c(iid,iida), function(iid){
  cond <- all_areas_nuseds$IndexId == iid
  return(unique(all_areas_nuseds$POPULATION[cond]))
  })

toRemove <- data.frame(IndexId = iid, 
                       GFE_ID = gfeid, 
                       dataset = "NUSEDS")
toRemove$comment <- paste("Unkown timing, not in CUSS; potential alternative series:",
                          trackRecord_nuseds_iid$alternative_IndexId[1])
removed_all <- rbind(removed_all,toRemove)

cond <- all_areas_nuseds$IndexId == iid & 
  all_areas_nuseds$GFE_ID == gfeid

all_areas_nuseds <- all_areas_nuseds[!cond,]
nrow(all_areas_nuseds) # 308231 308232
```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` was not merged to any of the alternative series because of its unknown run timing (see below). It is consequently removed from **NUSEDS**.

```{r, echo = FALSE}
show
```

```{r, include=FALSE}
removed_here <- removed_all[1,]
removed_here$IndexId <- iid
removed_here$GFE_ID <- gfeid
removed_here$dataset <- "NUSEDS"
comment <- paste("Not merged to alternative series IndexId =",
                 paste(iid,collapse = " or "),"& GFE_ID =",gfeid,"because of unknown run timing")
removed_here$comment <- comment
removed <- rbind(removed,removed_here)
```

```{r, include=FALSE}
i <- 2
#' Case with CN_3334 (i = 2): UNKNOWN TIMING
#' Temporal fields show contradictions.
#' TODO: remove because they cannot be attributed to either alternative series
iid <- c("CN_3334")
gfeid <- trackRecord_nuseds_iid$GFE_ID[trackRecord_nuseds_iid$IndexId == iid]
cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
unique(all_areas_nuseds[cond,c("START_DTT","END_DTT")]) # all year
unique(all_areas_nuseds[cond,c("STREAM_ARRIVAL_DT_FROM","STREAM_ARRIVAL_DT_TO")]) # spring
unique(all_areas_nuseds[cond,c("PEAK_SPAWN_DT_FROM","PEAK_SPAWN_DT_TO")]) # summer/fall
unique(all_areas_nuseds[cond,c("END_SPAWN_DT_FROM","END_SPAWN_DT_TO")])   # fall

# retain the POPULATION for the different IndexId
iida <- trackRecord_nuseds_iid$alternative_IndexId[trackRecord_nuseds_iid$IndexId == iid]
iida <- strsplit(x = iida, split = " ; ")[[1]]
show <- data.frame(IndexId =  c(iid,iida), 
                   type = c("focal",rep("alternative",length(iida))))

show$POPULATION <- sapply(c(iid,iida), function(iid){
  cond <- all_areas_nuseds$IndexId == iid
  return(unique(all_areas_nuseds$POPULATION[cond]))
  })

toRemove <- data.frame(IndexId = iid, 
                       GFE_ID = gfeid, 
                       dataset = "all_areas_nuseds")
toRemove$comment <- paste("Unkown timing, not in conservation_unit_system_sites; potential alternative series:",
                          trackRecord_nuseds_iid$alternative_IndexId[1])
removed_all <- rbind(removed_all,toRemove)

cond <- all_areas_nuseds$IndexId == iid & 
  all_areas_nuseds$GFE_ID == gfeid
all_areas_nuseds <- all_areas_nuseds[!cond,]
nrow(all_areas_nuseds) # 308195
```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` was initially going to be merged to the alternative series with which is was 100% compatible. But is was decided to remove it from **NUSEDS** because its run timing is unknown:

```{r, echo=FALSE}
show
```

```{r, include=FALSE}
removed_here <- removed_all[1,]
removed_here$IndexId <- iid
removed_here$GFE_ID <- gfeid
removed_here$dataset <- "NUSEDS"
comment <- paste("Not merged to alternative series IndexId =",
                 paste(iida,collapse = " or "),"& GFE_ID =",gfeid,"because of unknown run timing")
removed_here$comment <- comment
removed <- rbind(removed,removed_here)
```

```{r, include = F}
i <- 3
#' Case with CN_39983 (i = 3):
#' It is not in the PSE
#' TODO: add to CUSS. Note that the POP_ID is not in CUSS nor in the PSE (or decoder)
#' There is consequently no CU associated to it.
#' But it is very close to the Nanaimo river for which there is a Chinook summer 
#' (i.e. ) for which the Chemainus river is included as a spawning location
#'  https://salmonwatersheds.slack.com/archives/CJ5RVHVCG/p1709659637606539
trackRecord_nuseds_iid[3,]
iid <- trackRecord_nuseds_iid[3,]$IndexId
gfeid <- trackRecord_nuseds_iid[3,]$GFE_ID

# retain the POPULATION for the different IndexId
iida <- trackRecord_nuseds_iid$alternative_IndexId[trackRecord_nuseds_iid$IndexId == iid]
iida <- strsplit(x = iida, split = " ; ")[[1]]
show <- data.frame(IndexId =  c(iid,iida), 
                   type = c("focal",rep("alternative",length(iida))))

show$POPULATION <- sapply(c(iid,iida), function(iid){
  cond <- all_areas_nuseds$IndexId == iid
  return(unique(all_areas_nuseds$POPULATION[cond]))
  })
```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` was not merged to the alternative series because of different run timings:

```{r, echo=F}
show
```

It was decided instead to associate the population `r iid` to the CU *East Vancouver Island-Georgia Strait (Summer 4-1)* in the PSE because of the same run timing and the fact that the Chemainus river is connected to this CU. The corresponding `CU_NAME` in **CUSS** is:

```{r, include=F}
# attribute the East Vancouver Island-Georgia Strait (Summer 4-1) CU:
cond <- conservationunits_decoder$cu_name_pse == "East Vancouver Island-Georgia Strait (Summer 4-1)"
cu_decoder_here <- conservationunits_decoder[cond,]

#' find the CU-related information for East Vancouver Island-Georgia Strait 
#' (Summer 4-1) in CUSS:
cond <- conservation_unit_system_sites_all$CU_NAME == toupper(cu_decoder_here$cu_name_dfo) # does not work
sum(cond) # 0

cond <- grepl(toupper("East Vancouver Island-Georgia Strait"),
              conservation_unit_system_sites_all$CU_NAME) & 
  conservation_unit_system_sites_all$SPECIES_QUALIFIED == "CK"
conservation_unit_system_sites_all[cond,]
```

```{r, echo=F}
unique(conservation_unit_system_sites_all$CU_NAME[cond])
```

The reference of the `r paste(iid,gfeid,sep = " - ")` time series is added to **CUSS**. The CU-related fields in **CUSS** are filled with the values corresponding to the above `CU_NAME`. Here below is the row added to **CUSS**:

```{r, echo=F}
# add to CUSS
cuss_new <- CUSS_newRow_fun(IndexId = iid, 
                            GFE_ID = gfeid,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

cu_fields <- c("CU_ACRO","CU_INDEX","CU_LAT","CU_LONGT","CU_NAME","CU_TYPE",
               "FULL_CU_IN","FAZ_ACRO","MAZ_ACRO","JAZ_ACRO")

cu_fields_info <- unique(conservation_unit_system_sites_all[cond,cu_fields])

for(f in colnames(cu_fields_info)){
  cuss_new[,f] <- cu_fields_info[,f]
}
rownames(cuss_new) <- NULL
cuss_new
```

```{r, include = F}
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CN_39983",
                    GFE_ID = 1204,
                    # SYSTEM_SITE = cuss_new$SYSTEM_SITE,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = "Series not in CUSS; POP_ID not in CUSS but attributed to CU_NAME: EAST VANCOUVER ISLAND-GEORGIA STRAIT_SU_0.3")

# added_all <- rbind(added_all,toAdd)
added_all <- toAdd
```

```{r, include = FALSE}
#' Case with CN_7809 (i = 4):
#' CN_7809 is Summer run type, while CN_48442 is Run 1 --> not contradictory.
#' But series with CN_7809 is much longer and recent than the CN_48442 one.
#' Looks like the two series are merged in the PSE (look for CU "Okanagan").
#' TODO: change series CN_48442 - 442 in CUSS for CN_7809 - 442.
#' --> change IndexId in CUSS
i <- 4
iid <- trackRecord_nuseds_iid$IndexId[i]
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]
```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` can be merged to the alternative series `r paste(iid_alter,gfeid,sep = " - ")` with which it is 100% compatible. The run timing indicated in `POPULATION` in **NUSEDS** are not incompatible: 

```{r, echo=FALSE}
sapply(c(iid,iid_alter), function(p){
  cond <- all_areas_nuseds$IndexId == p
  return(unique(all_areas_nuseds$POPULATION[cond]))
})
```

However, we decide to merge the alternative time series to the focal one (i.e., change `r paste(iid_alter,gfeid,sep = " - ")` to `r paste(iid,gfeid,sep = " - ")`) instead of the contrary because the latter is longer and more recent. Consequently both **NUSEDS** and **CUSS** are edited.
 
```{r, echo = FALSE}
# Remove alternative series from CUSS and NUSEDS
toRemove <- data.frame(IndexId = iid_alter, 
                       GFE_ID = gfeid, 
                       dataset = "CUSS")
toRemove$comment <- paste0("Merged to series IndexId = ",iid," - GFE_ID = ",gfeid,", which was added to CUSS")
removed_all <- rbind(removed_all,toRemove)

# Add focal series to CUSS
cond <- conservation_unit_system_sites$GFE_ID == gfeid
SYSTEM_SITE <- conservation_unit_system_sites$SYSTEM_SITE[cond]
cond <- conservation_unit_system_sites$IndexId %in% c(iid,iid_alter)
CU_NAME <- unique(conservation_unit_system_sites$CU_NAME[cond])

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = CU_NAME,
                    comment = paste0("Series not in CUSS; alternative series ",iid_alter," - ",gfeid," was merged to the series because it is longer and more recent"))
added_all <- rbind(added_all,toAdd)




# edit indexId - related fields in CUSS 
conservation_unit_system_sites <- fields_edit_NUSEDS_CUSS_fun(edit_CUSS = T, 
                                                IndexId_focal = iid_alter,   # yes here the one to change is iid_alter 
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

# merge series in all_areas_nuseds by changing CN_48442 for CN_7809
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = iid_alter,   # yes here the one to change is iid_alter 
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

```

```{r, include=FALSE}
i <- 5
iid <- trackRecord_nuseds_iid$IndexId[i]
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]
```

In the case `i =` `r i` above, the focal series `r paste(iid,gfeid,sep = " - ")` is removed from **NUSEDS** because it is 100% duplicated with the alternative series `r paste(iid_alter,gfeid,sep = " - ")`.

```{r, include=FALSE}
i <- 6
iid <- trackRecord_nuseds_iid$IndexId[i]
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]
```

In the case `i =` `r i` above, the focal series `r paste(iid,gfeid,sep = " - ")` is removed from **NUSEDS** because of a different run timing (in `POPULATION`) compared to the alternative series (see below) and most values are 0s.

```{r, echo=FALSE}
sapply(c(iid,iid_alter), FUN = function(p){
  cond <- all_areas_nuseds$IndexId == p
  return(unique(all_areas_nuseds$POPULATION[cond]))
})
```

```{r, include = FALSE}
toRemove <- data.frame(IndexId = iid, 
                       GFE_ID = gfeid, 
                       dataset = "NUSEDS")
toRemove$comment <- paste("Not in CUSS; not merged to ",iid_alter," - ",gfeid," because of different run timing and almost only 0s")

removed_all <- rbind(removed_all,toRemove)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds,
                                           toRemove = toRemove, 
                                           fields = c("IndexId","GFE_ID"))
```


### Alternative GFE_ID

The focal time series (i.e., a unique `IndexId` - `GFE_ID` not in **CUSS**) are compared to alternative series with a different `GFE_ID` and potentially a different `IndexId` (but of the same species). 

```{r, include=FALSE}
cond <- trackRecord_nuseds$alternative_GFE_ID != "none" &
  # trackRecord_nuseds$alternative_IndexId == "none" &
  !cond_3
trackRecord_nuseds_gfeid <- trackRecord_nuseds[cond,]
trackRecord_nuseds_gfeid <- trackRecord_nuseds_gfeid[order(trackRecord_nuseds_gfeid$IndexId),]
trackRecord_nuseds_gfeid
nrow(trackRecord_nuseds_gfeid) # 34
trackRecord_nuseds_gfeid$i <- NA
```

There are `r nrow(trackRecord_nuseds_gfeid)` time series concerned:

```{r, echo=FALSE}
show <- trackRecord_nuseds_gfeid[,c("IndexId","GFE_ID","nb_dataPt","alternative_IndexId","alternative_GFE_ID")]
row.names(show) <- NULL
show
```

Notice in the table above that several time series have the same `IndexId`. Again this is problematic because normally only one `GFE_ID` can be associated to a given `IndexId` (i.e., `POP_ID`). We show here after the focal time series grouped with their alternative series. On top of each figure is shown the `POPULATION` and `WATERBODY` associated with each `IndexId` (i.e., `POP_ID`) and `GFE_ID`, respectively. Belong each figure is shown a summary table providing the number of data points (`nb_dataPt`) and the % of them that are `complementary`, `duplicate` and in `conflict` compared with the alternative series. The decision made in each case are provided after the figures, using the index `i` shown at the bottom left of the plots for reference. 

```{r, echo = F, fig.width = 15, fig.height = 12}
#' There several instances where a same IndexId appears multiple time (i.e., with
#' a different GFE_ID) but the same GFE_ID is proposed as an alternative.
#' --> consider those in group.
IndexId_GFE_ID_alternative <- unique(paste(trackRecord_nuseds_gfeid$IndexId,
                                           trackRecord_nuseds_gfeid$alternative_GFE_ID,
                                           sep = "&"))
# length(IndexId_GFE_ID_alternative) # 22

# change order based on GFE_ID_alternative
GFE_ID_alternative <- sapply(X = IndexId_GFE_ID_alternative, 
                             FUN = function(x){strsplit(x = x, split = "&")[[1]][2]})

IndexId_GFE_ID_alternative <- IndexId_GFE_ID_alternative[order(GFE_ID_alternative)]

series_compare <- list()
series_MAX_ESTIMATE <- list()
for(i in 1:length(IndexId_GFE_ID_alternative)){
  # i <- 10
  
  iid <- strsplit(IndexId_GFE_ID_alternative[i],"&")[[1]][1]
  gfeid_alter <- strsplit(IndexId_GFE_ID_alternative[i],"&")[[1]][2]
  
  cond <- trackRecord_nuseds_gfeid$IndexId == iid
  gfeids <- trackRecord_nuseds_gfeid$GFE_ID[cond]
  
  trackRecord_nuseds_gfeid$i[cond] <- i
  
  # check if there is also potential alternative IndexId
  cond <- trackRecord_nuseds_gfeid$IndexId == iid & 
    trackRecord_nuseds_gfeid$alternative_GFE_ID == gfeid_alter
  trackRecord_nuseds_gfeid_cut <- trackRecord_nuseds_gfeid[cond,]
  
  if(any(trackRecord_nuseds_gfeid_cut$alternative_IndexId != "none")){
    m <- matrix(1:2, ncol = 1)
  }else{
    m <- matrix(1)
  }
  
  # case with the alternative GFE_ID
  cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid_alter
  series_alter <- all_areas_nuseds$MAX_ESTIMATE[cond]
  names(series_alter) <- all_areas_nuseds$Year[cond]
  
  compare <- data.frame(IndexId = rep(iid,length(gfeids)),
                        GFE_ID = gfeids,
                        IndexId_alter = rep(NA,length(gfeids)),
                        GFE_ID_alter = rep(gfeid_alter,length(gfeids)))
  
  compare2 <- sapply(X = gfeids, FUN = function(g){
    cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == g
    series_focal <- all_areas_nuseds$MAX_ESTIMATE[cond]
    names(series_focal) <- all_areas_nuseds$Year[cond]
    out <- compare_series_fun(series_focal = series_focal, 
                              series_compare = series_alter,
                              percentage = T)
    return(out)
  })
  compare2 <- as.data.frame(t(compare2))
  
  compare <- cbind(compare,compare2)
  rownames(compare) <- NULL
  
  # keep the MAX_ESTIMATE for checking out later
  series_df <- data.frame(year = as.numeric(names(series_alter)),
                          s = series_alter)
  names(series_df)[names(series_df) == "s"] <- paste(iid,gfeid_alter,sep="-")
  for(g in gfeids){
    cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == g
    series_df_here <- data.frame(year = all_areas_nuseds$Year[cond],
                                 s = all_areas_nuseds$MAX_ESTIMATE[cond])
    names(series_df_here)[names(series_df_here) == "s"] <- paste(iid,g,sep = "-")
    
    series_df <- base::merge(x = series_df, y =  series_df_here, 
                             by = "year", all = T)
  }
  series_df$sum <- rowSums(series_df[colnames(series_df) != "year"], na.rm = T)
  
  series_MAX_ESTIMATE[[i]] <- series_df
  names(series_MAX_ESTIMATE)[i] <- paste0("i=",i)
  
  series_compare[[i]] <- compare
  names(series_compare)[i] <- paste0("i=",i)
  
  # in case these alternative IndexId:
  if(any(trackRecord_nuseds_gfeid_cut$alternative_IndexId != "none")){
    
    # compare:
    cond <- trackRecord_nuseds_gfeid_cut$alternative_IndexId != "none"
    trackRecord_nuseds_gfeid_cut_cut <- trackRecord_nuseds_gfeid_cut[cond,]
    
    compare_iid <- data.frame(IndexId = trackRecord_nuseds_gfeid_cut_cut$IndexId,
                              GFE_ID = trackRecord_nuseds_gfeid_cut_cut$GFE_ID,
                              IndexId_alter = trackRecord_nuseds_gfeid_cut_cut$alternative_IndexId,
                              GFE_ID_alter = rep(NA,nrow(trackRecord_nuseds_gfeid_cut_cut)))
    
    compare_iid2 <- sapply(X = 1:nrow(trackRecord_nuseds_gfeid_cut_cut), 
                           FUN = function(z){
                             # z <- 1
                             cond <- all_areas_nuseds$IndexId == trackRecord_nuseds_gfeid_cut_cut$IndexId[z] &
                               all_areas_nuseds$GFE_ID == trackRecord_nuseds_gfeid_cut_cut$GFE_ID[z] # == gfeid
                             series_focal <- all_areas_nuseds$MAX_ESTIMATE[cond]
                             names(series_focal) <- all_areas_nuseds$Year[cond]
                             
                             cond <- all_areas_nuseds$IndexId == trackRecord_nuseds_gfeid_cut_cut$alternative_IndexId[z] &
                               all_areas_nuseds$GFE_ID == trackRecord_nuseds_gfeid_cut_cut$GFE_ID[z] # == gfeid
                             series_alter <- all_areas_nuseds$MAX_ESTIMATE[cond]
                             names(series_alter) <- all_areas_nuseds$Year[cond]
                             out <- compare_series_fun(series_focal = series_focal, 
                                                       series_compare = series_alter,
                                                       percentage = T)
                             return(out)
                           })
    compare_iid2 <- as.data.frame(t(compare_iid2))
    
    compare_iid <- cbind(compare_iid,compare_iid2)
    rownames(compare_iid) <- NULL
    
    compare <- rbind(compare,compare_iid)
    series_compare[[i]] <- compare
    
    # time series:
    for(r in 1:nrow(trackRecord_nuseds_gfeid_cut_cut)){
      # r <- 1
      cond <- all_areas_nuseds$IndexId == trackRecord_nuseds_gfeid_cut_cut$alternative_IndexId[r] &
        all_areas_nuseds$GFE_ID == trackRecord_nuseds_gfeid_cut_cut$GFE_ID[r] # gfeid
      series_df_here <- data.frame(year = all_areas_nuseds$Year[cond],
                                   s = all_areas_nuseds$MAX_ESTIMATE[cond])
      names(series_df_here)[names(series_df_here) == "s"] <- paste(trackRecord_nuseds_gfeid_cut_cut$alternative_IndexId[r],
                                                                   trackRecord_nuseds_gfeid_cut_cut$GFE_ID[r],
                                                                   sep = "-")
      
      series_df <- base::merge(x = series_df, y =  series_df_here, 
                               by = "year", all = T)
      series_MAX_ESTIMATE[[i]] <- series_df
    }
  }
  
  ylim <- range(series_df[,!colnames(series_df) %in% c("year","sum")], na.rm = T)
  xlim <- range(series_df$year)
  
  print(paste("*** i =",i,"***"))
  print(compare)
  
  # plot
  layout(m)
  
  if(any(trackRecord_nuseds_gfeid_cut$alternative_IndexId != "none")){ # if two plot on top of each others
    side1 <- 0
    xaxt <- "n"
    xlab <- ""
  }else{
    side1 <- .5
    xaxt <- "n"
    xlab <- "Years"
  }
  
  par(mar = c(side1,4.5,3,.5))
  
  WATERBODYs <- sapply(X = c(gfeid_alter,gfeids),FUN = function(g){
    cond <- all_areas_nuseds$GFE_ID == g
    return(unique(all_areas_nuseds$WATERBODY[cond]))
  })
  
  cond <- all_areas_nuseds$IndexId == iid
  POPULATION <- unique(all_areas_nuseds$POPULATION[cond])
  
  plot_IndexId_GFE_ID_fun(IndexIds = rep(iid,length(gfeids) + 1),
                          GFE_IDs = c(gfeid_alter,gfeids),
                          all_areas_nuseds = all_areas_nuseds, 
                          Xlim = xlim, Ylim = ylim, 
                          xlab = xlab, xaxt = xaxt)
  
  mtext("IndexId - GFE_ID", side = 3, line = 1, adj = 0)
  mtext("POPULATION", side = 3, line = 1, adj = .5)
  mtext("WATERBODY", side = 3, line = 1, adj = 1)
  space_here <- "                                           "
  text_here <- paste(space_here,c("alternative","focal"), sep = "")
  legend("topleft",text_here, col = NA, pch = 16, lwd = 2, bty = "n")
  legend("top",POPULATION,bty = "n")
  legend("topright",WATERBODYs,bty = "n")
  legend("bottomleft",paste("i =",i),bty = "n")
  
  # case with alternative IndexId:
  if(any(trackRecord_nuseds_gfeid_cut$alternative_IndexId != "none")){
    
    par(mar = c(4.5,4.5,.5,.5))
    
    plot_IndexId_GFE_ID_fun(IndexIds = c(trackRecord_nuseds_gfeid_cut_cut$alternative_IndexId,
                                         trackRecord_nuseds_gfeid_cut_cut$IndexId),
                            GFE_IDs = c(trackRecord_nuseds_gfeid_cut_cut$GFE_ID,trackRecord_nuseds_gfeid_cut_cut$GFE_ID),
                            all_areas_nuseds = all_areas_nuseds,
                            Xlim = xlim, Ylim = ylim)
    
    POPULATION <- sapply(X = c(trackRecord_nuseds_gfeid_cut_cut$alternative_IndexId,
                               trackRecord_nuseds_gfeid_cut_cut$IndexId),
                         FUN = function(g){
                           cond <- all_areas_nuseds$IndexId == g
                           return(unique(all_areas_nuseds$POPULATION[cond]))
                         })
    
    text_here <- paste(space_here,
                       c(rep("alternative",nrow(trackRecord_nuseds_gfeid_cut_cut)),"focal"), sep = "")
    legend("topleft",text_here, col = NA, pch = 16, lwd = 2, bty = "n")
    legend("topright",rep(WATERBODYs[trackRecord_nuseds_gfeid_cut_cut$GFE_ID],nrow(trackRecord_nuseds_gfeid_cut_cut)), bty = "n")
    legend("top",POPULATION, bty = "n")
    legend("bottomleft",paste("i =",i),bty = "n")
  }
}
```

```{r, include = F}
#' Cases with SOMASS-SPROAT-GC SYSTEM  (i = 1 to 4) ***
#' CM (i = 1) --> merge potentially but check streamID --> only a few make it up the falls --> keep separate 
#' CN (i = 2) --> combine red and green and remove blue --> SUM ALL OF THEM because most individual chinook would pass the falls
#' PK (i = 3) --> ?
#' SX (i = 4) --> top plot: don't mix, bottom: combine series and FLAG TO BRUCE cf. email forwarded


#' CM (i = 1) keep separate because only a few make it up the falls
#' Need to add the time series to CUSS --> new GFE_ID
i <- 1
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i]
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i]
gfeid_a <-  trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
```

In case i = `r i`: series `r paste(iid,gfeid,sep = " - ")` is not merged to alternative series `r paste(iid,gfeid_a,sep = " - ")` because these chum salmon would not be able to make it up the fall. Consequently, the reference of the focal series is added to **CUSS**. 

Note that `GFE_ID` = `r gfeid_a` is present in DFO streams  file (under `ID`) but coordinates are not:

```{r, echo=FALSE}
cuss_new <- CUSS_newRow_fun(IndexId = iid, 
                            GFE_ID = gfeid,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# the GFE_ID is not in CUSS so the GIS information has to be found by hand:
# c(cuss_new$Y_LAT,cuss_new$X_LONGT)

# And the GFE_ID is not in the DFO streams  file:
cond <- DFO_All_Streams_Segments$ID == as.numeric(gfeid)
DFO_All_Streams_Segments[cond,]
```

We consequently attribute coordinates to this location using Google Maps. We selecte the location just above Stamp Falls, on the left of the Stamp river fish ladder:

```{r, echo=FALSE}
#' Take GIS coordinates from Google map just above the Stamp falls (on the left of 
#' the Stamp river fish ladder):
#' Google uses the World Geodetic System WGS84 standard. --> same as in CUSS

show <- c(49.332224,-124.919717)
names(show) <- c("Y_LAT","X_LONGT")
show
```

```{r, include=FALSE}
# add to conservation_unit_system_sites
cuss_new$X_LONGT <- show["X_LONGT"]
cuss_new$Y_LAT <- show["Y_LAT"]
cuss_new$coordinates_changed <- T

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = paste0("Series not in CUSS, not merged to altenative series IndexId = ",iid," & GHE_ID = ",gfeid_a," because upper location; GFE_ID not in CUSS so coordinates were defined manually"))

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)
```


```{r, include=FALSE}
#' CN (i = 2) 
#' --> add green to CUSS
#' --> remove blue because points are in conflict with green and there 
#' are only four of them.
# obtain a new CUSS row:
i <- 2
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()

cuss_new <- CUSS_newRow_fun(IndexId = "CN_3306", 
                            GFE_ID = 11486,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "CN_3306",
                    GFE_ID = 11486,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = "Series not in CUSS, not merged to altenative series INdexId = CN_3306 & GHE_ID = 11485 because upper location; GFE_ID not in CUSS so coordinates were define by hand")

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)

#' remove blue series
removed <- data.frame(IndexId = "CN_3306",
                      GFE_ID = 11488)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS only 4 data points; not merged to potential series IndexId = CN_3306 & GFE_ID = 11485"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
```

In case i = `r i`: series `r paste(iid,"11486",sep = " - ")` in green is not merged to alternative series `r paste(iid,"11485",sep = " - ")` in red for the same reason as above; its reference are instead added to **CUSS**. The other focal series `r paste(iid,"11488",sep = " - ")` in blue is deleted because it only has 4 data points.

```{r, include=FALSE}
#' PKO (i = 3)
#' --> add blue to CUSS
i <- 3
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]

cuss_new <- CUSS_newRow_fun(IndexId = "PKO_3304",
                            GFE_ID = 11486,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "PKO_3304",
                    GFE_ID = 11486,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = "Series not in CUSS, not merged to altenative series INdexId = PKO_3304 & GHE_ID = 11485 because upper location; GFE_ID not in CUSS so coordinates were define by hand")

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: series `r paste("PKO_3304","11486",sep = " - ")` in blue is not merged to alternative series `r paste("PKO_3304","11485",sep = " - ")` in red for the same reason as above; its reference are instead added to **CUSS**.

```{r, include=FALSE}
#' SX (i = 4)
#' In bottom plot:
#' --> merge SX_3302 - 3416 (black) to SX_3310 - 3416 (red) in NUSEDS
#' --> merge SX_3302 - 3444 (blue)  to SX_3325 - 3444 (green) in NUSEDS
i <- 4 
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
 
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "SX_3302",
                                                IndexId_alter = "SX_3310",
                                                GFE_ID_focal = 3416,
                                                GFE_ID_alter = 3416,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "SX_3302",
                                                IndexId_alter = "SX_3325",
                                                GFE_ID_focal = 3444,
                                                GFE_ID_alter = 3444,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CN_3306","SX_3302"),
                      GFE_ID = c(3416,3444))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = SX_3310 & GFE_ID = 3416",
                     "Series not in CUSS, merged to alternative series IndexId = SX_3325 & GFE_ID = 3444")
removed_all <- rbind(removed_all,removed)
```

In case i = `r i`: series `r paste("PKO_3302","3416",sep = " - ")` in black (bottom plot) is merged to alternative series `r paste("SX_3310","3416",sep = " - ")` in red and series `r paste("PKO_3302","3444",sep = " - ")` in blue (bottom plot) is merged to alternative series `r paste("SX_3325","3444",sep = " - ")` in green. 

```{r, include=FALSE}
#' Cases with ALOUETTE RIVER (i = 5)
#' those are probably summed up -> a bit higher in PSE
#' In bottom plot: merge blue to red
#' In top plot: create new series in CUSS for black and blue
i <- 5
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]

#' In bottom plot: merge blue to red
#' CM_47925 --> CM_47928
removed <- data.frame(IndexId = c("CM_47925"),
                      GFE_ID = c(15))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = CM_47928 & GFE_ID = 15")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CM_47925",
                                                IndexId_alter = "CM_47928",
                                                GFE_ID_focal = 15,
                                                GFE_ID_alter = 15,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

```

In case i = `r i`: the focal series `r paste("CM_47925","15",sep = " - ")` in blue (bottom plot) is merged to the alternative series `r paste("CM_47928","15",sep = " - ")` in red (bottom plot). The other two focal series `r paste("CM_47925","31516",sep = " - ")` in black (top plot) and `r paste("CM_47925","31740",sep = " - ")` in blue (top plot) are added to **CUSS**. 

```{r, include=FALSE}
#' In top plot: create new series in CUSS for black and blue
#' - black: CM_47925 - 31516 --> GFE_ID not in CUSS, need to find the coordinates TODO
#' - blue:  CM_47925 - 31740 --> GFE_ID not in CUSS, need to find the coordinates TODO
cuss_new <- CUSS_newRow_fun(IndexId = "CM_47925",
                            GFE_ID = 31516,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# it is not in the original conservation_unit_system_sites_all:
cond <- conservation_unit_system_sites_all$GFE_ID == 31516
sum(cond) 
cuss_new$SYSTEM_SITE # MILLIONAIRE CREEK
cuss_new$Y_LAT
cuss_new$X_LONGT

# The coordinates are in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 31516
DFO_All_Streams_Segments[cond,]
cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "CM_47925",
                    GFE_ID = 31516,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS, not merged to altenative series IndexId = CM_47925 & GHE_ID = 14 because different location; GFE_ID not in CUSS so coordinates were define by hand")

added_all <- rbind(added_all,toAdd)
```

```{r, include=FALSE}
cuss_new <- CUSS_newRow_fun(IndexId = "CM_47925",
                            GFE_ID = 31740,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# it is not in the original conservation_unit_system_sites_all:
cond <- conservation_unit_system_sites_all$GFE_ID == 31740
sum(cond) 
cuss_new$SYSTEM_SITE # LATIMER CREEK
cuss_new$Y_LAT
cuss_new$X_LONGT

# The coordinates are in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 31740
DFO_All_Streams_Segments[cond,]
cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "CM_47925",
                    GFE_ID = 31740,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS, not merged to altenative series IndexId = CM_47925 & GHE_ID = 14 because different location; GFE_ID not in CUSS so coordinates were define by hand")

added_all <- rbind(added_all,toAdd)
```

```{r, include=FALSE}
#' Cases with SWIFT RIVER / COTTONWOOD RVER (i = 6)
#' Fraser
#' --> combined in the PSE same in the PSE: Middle Fraser River Spring 
#' TODO: merge the the blue series to the red
#' --> change GFE_ID 2464 to 142
#' CORRECTION: we do not do the change above but instead create a new row in 
#' conservation_unit_system_sites
i <- 6
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]

series_MAX_ESTIMATE[i]

# add to CUSS
cuss_new <- CUSS_newRow_fun(IndexId = "CN_47277", 
                            GFE_ID = 2464,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# The coordinates are not in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 2464
DFO_All_Streams_Segments[cond,]
 
#' Consequently the coordinate where defined using Google Maps and they correspond 
#' to the mouth of Cottonwood river
cuss_new$X_LONGT <- -122.610584
cuss_new$Y_LAT <- 53.119965
cuss_new$coordinates_changed <- T

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CN_47277",
                    GFE_ID = 2464,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "GFE_ID not in CUSS")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CN_47277","2464",sep = " - ")` in blue is not merged to the alternative series `r paste("CN_47277","142",sep = " - ")` in red ; it is instead added to **CUSS**. 

The `GFE_ID` is present in the DFO streams file but coordinates are not:

```{r, echo=FALSE}
cond <- DFO_All_Streams_Segments$ID == 2464
DFO_All_Streams_Segments[cond,]
```

The coordinate for this location are consequently defined manually using Google Maps; they corresponds to the mouth of Cottonwood river:

```{r, echo=FALSE}
rownames(cuss_new) <- NULL
cuss_new[,c("SYSTEM_SITE","GFE_ID","X_LONGT","Y_LAT")]
```

```{r, include=FALSE}
#' Cases with NICOLA RIVER (i = 7)
#' TODO: 
#' - merge green to blue --> GFE_ID from 2461 to 213 
#' - create a new series in CUSS for the blue because the dam is closer to the 
#' UPPER NICOLA RIVER and should consequently not be merged to lower parts of the 
#' river. The dam is even closer to Clapperton Creek, which the time series is 
#' shown below. But its POP_ID is different so merging is excluded.
i <- 7
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]

series_MAX_ESTIMATE[i]

# cond <- grepl("CLAPPERTON",all_areas_nuseds$WATERBODY)
# sum(cond)
# unique(all_areas_nuseds$IndexId[cond])
# unique(all_areas_nuseds$GFE_ID[cond])
# plot_IndexId_GFE_ID_fun(IndexIds = c("CO_46170","CO_44965"),
#                         GFE_IDs = c(54282,2370),
#                         all_areas_nuseds = all_areas_nuseds)

#' - merge green to blue --> GFE_ID from 2461 to 213 in NUSEDS
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46170",
                                                IndexId_alter = "CO_46170",
                                                GFE_ID_focal = 2461,
                                                GFE_ID_alter = 213,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46170"),
                      GFE_ID = c(2461))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_46170 & GFE_ID = 213"
removed_all <- rbind(removed_all,removed)

#' - create a new series in CUSS for the blue:
cuss_new <- CUSS_newRow_fun(IndexId = "CO_46170",
                            GFE_ID = 54282,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

cuss_new$Y_LAT
cuss_new$X_LONGT

# The coordinates are in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 213
DFO_All_Streams_Segments[cond,]
cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CO_46170",
                    GFE_ID = 54282,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CO_46170 - 213 because of different location")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CO_46170","2461",sep = " - ")` in green is merged to the alternative series `r paste("CO_46170","213",sep = " - ")` in red ; while the other focal series `r paste("CO_46170","54282",sep = " - ")` in blue is instead added to **CUSS**.

```{r, include=FALSE}
#' Cases with STEON RIVER - CN (i = 8)
#' blue is actually a duplicate of the red in lower plot --> remove from nuseds
i <- 8
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
series_compare[[i]]
series_MAX_ESTIMATE[i]

removed <- data.frame(IndexId = c("CN_2178"),
                      GFE_ID = 129)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, duplicates of series IndexId = CN_47189 & GFE_ID = 129"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
```

In case i = `r i`: the focal series `r paste("CN_2178","129",sep = " - ")` in blue is a duplicate of the atlernative series `r paste("CN_47189","129",sep = " - ")` in red (bottom plot); it is consequently removed from **NUSEDS**.

```{r, include=FALSE}
#' Cases with STEON RIVER / PORTAGE CREEK - CO (i = 9)
#' All are in the Seton River near Lillooets
#' - top plot: DO NOT merge blue to red because there is a conflict in 2013
#'   --> create a new row in CUSS
#' - bottom plot: merge blue to red --> change IndexId from CO_44539 to CO_47183 in NUSEDS
i <- 9
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

#' - top plot: create a new row in CUSS for CO_44539 - 2451 (2451 is already in CUSS)
sum(conservation_unit_system_sites_all$GFE_ID == 2451)

cuss_new <- CUSS_newRow_fun(IndexId = "CO_44539",
                            GFE_ID = 2451,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CO_44539",
                    GFE_ID = 2451,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CO_44539 - 2476 because of one conflictual data point")

added_all <- rbind(added_all,toAdd)

#' - bottom plot: merge blue to red --> change IndexId from CO_44539 to CO_47183 
#' in NUSEDS
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_44539",
                                                IndexId_alter = "CO_47183",
                                                GFE_ID_focal = 129,
                                                GFE_ID_alter = 129,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_44539"),
                      GFE_ID = c(129))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_47183 & GFE_ID = 129"
removed_all <- rbind(removed_all,removed)
```

In case i = `r i`: the focal series `r paste("CO_44539","2451",sep = " - ")` in blue (top plot) is not merged to the alternative series `r paste("CO_44539","2476",sep = " - ")` in red because of a conflicting point; its reference is instead added to **CUSS**. The second focal series `r paste("CO_44539","129",sep = " - ")` in blue (bottom plot) is merged to the alternative series `r paste("CO_47183","129",sep = " - ")` in red.

```{r include=FALSE}
#' Cases with THOMPSON RIVER CO (i = 10)
#' --> add these series to CUSS --> new GFE_IDs
i <- 10
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

# All the GFE_IDs of the focal locations do not have coordinates in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID %in% trackRecord_nuseds_gfeid$GFE_ID[cond_i]
DFO_All_Streams_Segments[cond,]

#' so we used Google Maps and the map in p.31 of Arbeider et al. 2020. Interior 
#' Fraser Coho Salmon Recovery Potential Assessment
#' https://waves-vagues.dfo-mpo.gc.ca/library-bibliotheque/40888721.pdf
#' to define these coordinates manually.
DFO_streams_here <- DFO_All_Streams_Segments[cond,] |> as.data.frame()
DFO_streams_here[1,c("Y_LAT","X_LONGT")] <- c(51.598602,-119.889197) 
DFO_streams_here[2,c("Y_LAT","X_LONGT")] <- c(52.345236,-119.177796)  
DFO_streams_here[3,c("Y_LAT","X_LONGT")] <- c(51.593091,-119.701668) 
DFO_streams_here[4,c("Y_LAT","X_LONGT")] <- c(51.579465,-119.810014) 
DFO_streams_here[5,c("Y_LAT","X_LONGT")] <- c(52.281312,-119.173514)

for(gfeid in trackRecord_nuseds_gfeid$GFE_ID[cond_i]){
  # gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i][1]
  
  cuss_new <- CUSS_newRow_fun(IndexId = "CO_46582",
                              GFE_ID = gfeid,
                              conservation_unit_system_sites = conservation_unit_system_sites,
                              all_areas_nuseds = all_areas_nuseds)
  
  cond <- DFO_streams_here$ID == gfeid
  cuss_new$Y_LAT <- DFO_streams_here$Y_LAT[cond] |> as.numeric()
  cuss_new$X_LONGT <- DFO_streams_here$X_LONGT[cond] |> as.numeric()
  cuss_new$coordinates_changed <- T

  print(cuss_new[,c("GFE_ID","SYSTEM_SITE","X_LONGT","Y_LAT")])
  
  conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                          cuss_new)
  
  toAdd <- data.frame(IndexId ="CO_46582",
                      GFE_ID = gfeid,
                      dataset = "CUSS",
                      CU_NAME = cuss_new$CU_NAME,
                      comment = "Series not in CUSS and not merged with CO_46582 - 256 because of different location")

  added_all <- rbind(added_all,toAdd)
}
```

In case i = `r i`: all five focal series are added to **CUSS**. Their `GFE_ID` are present in the DFO streams but the coordinates are not:

```{r,echo=FALSE}
cond <- DFO_All_Streams_Segments$ID %in% trackRecord_nuseds_gfeid$GFE_ID[cond_i]
DFO_All_Streams_Segments[cond,]
```

The coordinates are consequently defined manually using Google Maps and the map in page 31 of [Arbeider et al. 2020. Interior Fraser Coho Salmon Recovery Potential Assessment](https://waves-vagues.dfo-mpo.gc.ca/library-bibliotheque/40888721.pdf):

```{r, echo=FALSE}
colnames(DFO_streams_here) <- c("SYSTEM_SITE","GFE_ID","X_LONGT","Y_LAT")
DFO_streams_here
```

```{r, include=FALSE}
#' Cases with BARRIER RIVER (i = 11)
#' TODO:
#' - bottom plot: merge blue to red --> change IndexId in NUSEDS 
#' - top plot: create new series in CUSS for green
i <- 11
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

#' - bottom plot: merge blue to red --> change IndexId in NUSEDS 
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46602",
                                                IndexId_alter = "CO_46632",
                                                GFE_ID_focal = 2746,
                                                GFE_ID_alter = 2746,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46602"),
                      GFE_ID = c(2746))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_46632 & GFE_ID = 2746"
removed_all <- rbind(removed_all,removed)

#' - top plot: create new series in CUSS for green
cuss_new <- CUSS_newRow_fun(IndexId = "CO_46602",
                            GFE_ID = 212716981,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# The coordinates are in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 212716981
DFO_All_Streams_Segments[cond,]
cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CO_46602",
                    GFE_ID = 212716981,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CO_46632 - 258 because of different location")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CO_46602","2746",sep = " - ")` in blue (bottom plot) is merged to the alternative series `r paste("CO_46632","2476",sep = " - ")` in red. The other focal series `r paste("CO_46602","212716981",sep = " - ")` in green (top plot) is added to **CUSS**.

```{r,include=FALSE}
#' Cases with FENNELL CREEK / SASKUM CREEK (i = 12, 13)
#' TODO: merge for both --> change GFE_ID in NUSEDS
i <- 12
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "SX_3416",
                                                IndexId_alter = "SX_3416",
                                                GFE_ID_focal = 2746,
                                                GFE_ID_alter = 261,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("SX_3416"),
                      GFE_ID = c(2746))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series SX_3416 & GFE_ID = 261"
removed_all <- rbind(removed_all,removed)
```

In case i = `r i`: the focal series `r paste("SX_3416","2746",sep = " - ")` in blue (bottom plot) is merged to the alternative series `r paste("SX_3416","261",sep = " - ")` in red.

```{r, include=FALSE}
i <- 13
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46632",
                                                IndexId_alter = "CO_46632",
                                                GFE_ID_focal = 261,
                                                GFE_ID_alter = 2746,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46632"),
                      GFE_ID = c(261))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_46632 & GFE_ID = 2746"
removed_all <- rbind(removed_all,removed)
```

```{r, include=FALSE}
# Note that these two locations are very close to each other
cond <- conservation_unit_system_sites$GFE_ID %in% c(261,2746)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")]
```

In case i = `r i`: the focal series `r paste("CO_46632","261",sep = " - ")` in blue (bottom plot) is merged to the alternative series `r paste("CO_46632","2746",sep = " - ")` in red.

```{r, include=FALSE}
#' Cases with BLUE RIVER (i = 14)
#' series were added up in the PSE,
#' TODO:
#' - merge blue to red --> change GFE_ID
#' - create new series in CUSS for green
i <- 14
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]
series_MAX_ESTIMATE[i]
series_compare[[i]]

#' - merge blue to red --> change GFE_ID
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46795",
                                                IndexId_alter = "CO_46795",
                                                GFE_ID_focal = 33103,
                                                GFE_ID_alter = 281,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46795"),
                      GFE_ID = c(33103))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_46795 & GFE_ID = 281"
removed_all <- rbind(removed_all,removed)

#' - create new series in CUSS for green
cuss_new <- CUSS_newRow_fun(IndexId = "CO_46795",
                            GFE_ID = 1921661712,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)


# The coordinates are not in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 1921661712
DFO_All_Streams_Segments[cond,]

# So it must be defined manually: 
cuss_new[1,c("Y_LAT","X_LONGT")] <- c(52.112252,-119.289006) 
cuss_new$coordinates_changed <- T

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CO_46795",
                    GFE_ID = 1921661712,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged to CO_46795 & GFE_ID = 281 because of different location")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CO_46795","33103",sep = " - ")` in blue is merged to the alternative series `r paste("CO_46795","281",sep = " - ")` in red. The other focal series `r paste("CO_46795","1921661712",sep = " - ")` in green is added to **CUSS**. Its `GFE_ID` is in the DFO streams file but coordinates are not:

```{r, echo=FALSE}
cond <- DFO_All_Streams_Segments$ID %in% trackRecord_nuseds_gfeid$GFE_ID[cond_i]
DFO_All_Streams_Segments[cond,]
```

The coordinates are consequently defined manually using Google Maps:

```{r,echo=FALSE}
rownames(cuss_new) <- NULL
cuss_new[,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")]
```

```{r,include=FALSE}
#' Case 1 with CARIBOO RIVER (i = 15)
#' CN_46891 - 2467 is 100% duplicated with CN_46891 - 290
#' TODO: remove from NUSEDS
i <- 15
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]
series_compare[[i]]

removed <- data.frame(IndexId = c("CN_46891"),
                      GFE_ID = 2467)
removed$dataset <- "NUSEDS"
removed$comment <- "Duplicates of series IndexId = CN_46891 & GFE_ID = 290"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
```

In case i = `r i`: the focal series `r paste("CN_46891","2467",sep = " - ")` in blue is a duplicate of the alternative series `r paste("CN_46891","290",sep = " - ")` in red; it is consequently removed from **NUSEDS**.

```{r,include=FALSE}
i <- 16
```

In case i = `r i`: the focal series `r paste("CN_46892","2466",sep = " - ")` in blue has three duplicated points with the alternative time series `r paste("CN_46892","290",sep = " - ")` in red, and a conflicting point. However, this conflicting point in the alternative time series is a duplicated point in the third time series `r paste("CN_46891","290",sep = " - ")` in purple in the bottom plot below. We consequently (1) remove the duplicated point in the alternative series (in red) and (2) merge the focal series to the latter.

```{r, echo=FALSE, fig.width = 17, fig.height = 13}
layout(matrix(1:2,nrow = 2))
par(mar=c(4,4,.5,.5))
plot_IndexId_GFE_ID_fun(IndexIds = "CN_46892",all_areas_nuseds = all_areas_nuseds,
                        colPalette = c("deepskyblue3","firebrick"), pchs = 2:1, ltys = 2:1)
legend("top",c(NA,"focal","alternative"),bty = 'n')
legend("bottomleft",paste0("i = ",i),bty = 'n')
plot_IndexId_GFE_ID_fun(GFE_IDs = 290, species_acro = "CN",
                        all_areas_nuseds = all_areas_nuseds,pchs = c(3,1),ltys = c(2,1),
                        colPalette = c("purple","firebrick"))
```

```{r,include=FALSE,fig.width = 17, fig.height = 13}
#' Case 2 with CARIBOO RIVER (i = 16):
#' alternative CN_46892 - 290
#' This is a complicated case that was spotted by looking at the time series:
#' In the figure below:
#' - top plot: the alternative series has 3 points duplicating with the focal series
#' - bottom plot: the same alternative series has a duplicated point with another series
#' TODO: 
#' - remove the 5th point in the alternative series (IndexId = CN_46892 & GFE_ID = 290),
#' - then merge the focal series (CN_46892 - 2466) to it, taking care of the duplicated
#' points (i.e. removing them)

# alternative series:
cond_CN_46892_290 <- all_areas_nuseds$IndexId == "CN_46892" & 
  all_areas_nuseds$GFE_ID == 290
nuseds_CN_46892_290 <- all_areas_nuseds[cond_CN_46892_290,]

# focal series
cond_CN_46892_2466 <- all_areas_nuseds$IndexId == "CN_46892" & 
  all_areas_nuseds$GFE_ID == 2466
nuseds_CN_46892_2466 <- all_areas_nuseds[cond_CN_46892_2466,]

# remove the 5th point in nuseds_CN_46892_290, which is also the highest
r_toremove <- which(nuseds_CN_46892_290$MAX_ESTIMATE == max(nuseds_CN_46892_290$MAX_ESTIMATE, na.rm = T))
nuseds_CN_46892_290 <- nuseds_CN_46892_290[-r_toremove,]

# remove rows in nuseds_CN_46892_2466 with duplicated values in nuseds_CN_46892_290
colSelect <- c("Year","MAX_ESTIMATE")
data <- merge(nuseds_CN_46892_2466[,colSelect],
              nuseds_CN_46892_290[,colSelect],
              by = "Year", all.x = T)
data <- data[!is.na(data$MAX_ESTIMATE.x) &
               !is.na(data$MAX_ESTIMATE.y) &
               data$MAX_ESTIMATE.x == data$MAX_ESTIMATE.y,]

cond <- ! nuseds_CN_46892_2466$MAX_ESTIMATE %in% data$MAX_ESTIMATE.x
nuseds_CN_46892_2466 <- nuseds_CN_46892_2466[cond,]
nuseds_CN_46892_2466[,c("Year","MAX_ESTIMATE")]

# remove rows in nuseds_CN_46892_2466 with NAs for MAX_ESTIMATE in years already 
# present in nuseds_CN_46892_290 (to avoid creating duplicated years)
data <- merge(nuseds_CN_46892_2466[,colSelect],
              nuseds_CN_46892_290[,colSelect],
              by = "Year", all.x = T)
data <- data[!is.na(data$MAX_ESTIMATE.x),]
cond <- nuseds_CN_46892_2466$Year %in% data$Year
nuseds_CN_46892_2466 <- nuseds_CN_46892_2466[cond,]
nuseds_CN_46892_2466[,c("Year","MAX_ESTIMATE")]

# edit nuseds_CN_46892_2466 with new GFE_ID-related fields
for(f in fields_l$NUSEDS$GFE_ID){
  nuseds_CN_46892_2466[,f] <- unique(nuseds_CN_46892_290[,f])
}

#' edit data in all_areas_nuseds
all_areas_nuseds <- all_areas_nuseds[!(cond_CN_46892_290 | cond_CN_46892_2466),]
all_areas_nuseds <- rbind(all_areas_nuseds,
                          nuseds_CN_46892_2466,
                          nuseds_CN_46892_290)

# to check that the operation succeeded:
layout(matrix(1))
plot_IndexId_GFE_ID_fun(IndexIds = "CN_46892",all_areas_nuseds = all_areas_nuseds)

# edit removed_all
removed <- data.frame(IndexId = c("CN_46892"),
                      GFE_ID = c(2466))
removed$dataset <- "NUSEDS"
removed$comment <- "Merged to series CN_46892 & GFE_ID = 290 with which 3 data points were duplicated; one was duplicated with CN_46891 & GFE_ID = 290"
removed_all <- rbind(removed_all,removed)
```


```{r,include=FALSE}
#' Cases with PHILLIPS RIVER & CLEAR WATER CREEK (VIMI) (i = 17 to 22)
#' https://salmonwatersheds.slack.com/archives/CJ5RVHVCG/p1708020689543579?thread_ts=1707771319.134789&cid=CJ5RVHVCG
#' TODO: create a new series for all of them in CUSS
is <- 17:22

# coordinates are in trackRecord_nuseds_gfeid for focal location that is not in CUSS
cond <- trackRecord_nuseds_gfeid$i %in% is
gfeids <- trackRecord_nuseds_gfeid$GFE_ID[cond] |> as.numeric() |> unique()
cond <- DFO_All_Streams_Segments$ID %in% gfeids
DFO_All_Streams_Segments[cond,]

for(i in 17:22){
  # i <- 17
  cond_i <- trackRecord_nuseds_gfeid$i == i
  
  cuss_new <- CUSS_newRow_fun(IndexId = trackRecord_nuseds_gfeid$IndexId[cond_i],
                              GFE_ID = trackRecord_nuseds_gfeid$GFE_ID[cond_i],
                              conservation_unit_system_sites = conservation_unit_system_sites,
                              all_areas_nuseds = all_areas_nuseds)
  
  if(is.na(cuss_new$Y_LAT)){ # should only be needed one time
    cond <- DFO_All_Streams_Segments$ID == cuss_new$GFE_ID
    cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
    cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()
  }
  
  conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                          cuss_new)

  toAdd <- data.frame(IndexId = trackRecord_nuseds_gfeid$IndexId[cond_i],
                      GFE_ID = trackRecord_nuseds_gfeid$GFE_ID[cond_i],
                      dataset = "CUSS",
                      CU_NAME = cuss_new$CU_NAME,
                      comment = paste0("Series not in CUSS and not merged with ",
                                       trackRecord_nuseds_gfeid$IndexId[cond_i]," - ",
                                       trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i],
                                       " because of different location"))
  
  added_all <- rbind(added_all,toAdd)
}
```

In the remaining cases (i = `r paste0(is,collapse = ", ")`): the focal series have the same `IndexId` (i.e. `POP_ID`) but a different `GFE_ID` compared to their alternative series: the location CLEAR WATER CREEK is not present in **CUSS** and the location PHILLIPS RIVER is proposed as an alternative. We do not merge the focal series to their alternative series and add them to **CUSS** instead.

### No alternative series

```{r, include=FALSE}
cond <- trackRecord_nuseds$alternative_GFE_ID == "none" &
  trackRecord_nuseds$alternative_IndexId == "none" &
  !cond_3
trackRecord_nuseds_nocuss <- trackRecord_nuseds[cond,]
nb_rows <- nrow(trackRecord_nuseds_nocuss) # 37
rownames(trackRecord_nuseds_nocuss) <- NULL
```

There remain `r nb_rows` series in **NUSEDS** with no alternative series, i.e., both their `IndexId` (`POP_ID`) and `SPECIES & GFE_ID` are absent from **CUSS**. These series are removed from **NUSEDS** because we cannot associate them to a `CU_NAME`. It future, it would be worth attempting to salvage the longest series in the list. The figures below show these time series.

```{r,include=FALSE}
trackRecord_nuseds_nocuss
```

```{r, echo=FALSE, fig.width=14, fig.height=6}
#' TODO: delete them from NUSEDS because we cannot attribute them a CU_NAME.
#' TODO: in future we could spend some time finding the CU name for the series 
#' with many points

# add species to trackRecord_nuseds_nocuss
trackRecord_nuseds_nocuss$species <- sapply(trackRecord_nuseds_nocuss$IndexId,function(iid){
  if(grepl("CN",iid)){
    out <- "Chinook"
  }else if(grepl("CO",iid)){
    out <- "Coho"
  }else if(grepl("PK",iid)){
    out <- "Pink"
  }else if(grepl("CM",iid)){
    out <- "Chum"
  }else if(grepl("SX",iid)){
    out <- "Sockeye"
  }
  return(out)
})

# combine species and GFE_ID
trackRecord_nuseds_nocuss$species_GFE_ID <- paste(trackRecord_nuseds_nocuss$species,
                                                  trackRecord_nuseds_nocuss$GFE_ID,sep = "_")

CUSS_species_GFE_ID <- paste(conservation_unit_system_sites$SPECIES,
                             conservation_unit_system_sites$GFE_ID,sep = "_")

par(mar=c(4,4,.5,.5))
for(r in 1:nrow(trackRecord_nuseds_nocuss)){
  # r <- 1
  
  # check if IndexId is in CUSS
  cond <- conservation_unit_system_sites$IndexId == trackRecord_nuseds_nocuss$IndexId[r]
  if(sum(cond) > 0){
    IndexId_inCuss <- T
  }else{
    IndexId_inCuss <- F
  }
  
  # check if GFE_ID is in CUSS for this species
  cond <- trackRecord_nuseds_nocuss$species_GFE_ID[r] %in% CUSS_species_GFE_ID
    
  if(sum(cond) > 0){
    species_GFE_ID_inCuss <- T
  }else{
    species_GFE_ID_inCuss <- F
  }
  
  plot_IndexId_GFE_ID_fun(IndexIds = trackRecord_nuseds_nocuss$IndexId[r],
                          GFE_IDs = trackRecord_nuseds_nocuss$GFE_ID[r],
                          all_areas_nuseds = all_areas_nuseds)
  legend("bottomleft",paste("i =",r),bty = "n")
  legend("top",c(paste("IndexId is in CUSS:",IndexId_inCuss),
                 paste("SPECIES & GFE_ID is in CUSS:",species_GFE_ID_inCuss)),bty = "n")
  
  cond_gfeid <- all_areas_nuseds$GFE_ID ==  trackRecord_nuseds_nocuss$GFE_ID[r]
  WATERBODY <- all_areas_nuseds$WATERBODY[cond_gfeid] |> unique()
    cond_Population <- all_areas_nuseds$IndexId == trackRecord_nuseds_nocuss$IndexId[r]
  POPULATION <- all_areas_nuseds$POPULATION[cond_Population] |> unique()
  
  legend("topright",c(paste("WATERBODY:",WATERBODY),paste("POPULATION:",POPULATION)),bty = "n")
  
  removed <- data.frame(IndexId = trackRecord_nuseds_nocuss$IndexId[r],
                        GFE_ID = trackRecord_nuseds_nocuss$GFE_ID[r])
  removed$dataset <- "NUSEDS"
  removed$comment <- "Series not in CUSS, neither IndexId nor GFE_ID are in CUSS"
  removed_all <- rbind(removed_all,removed)

  #
  all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds,
                                             toRemove = removed,
                                             silience = T,
                                             fields = c("IndexId","GFE_ID"))
}
```

```{r, include=FALSE}
#' ** CHECKS **

# Check - normally all series in NUSEDS and in CUSS now:
series_nuseds <- paste(all_areas_nuseds$IndexId,
                       all_areas_nuseds$GFE_ID,sep = "&")
series_nuseds <- unique(series_nuseds)
length(series_nuseds) # 6911

series_cuss <- paste(conservation_unit_system_sites$IndexId,
                     conservation_unit_system_sites$GFE_ID,sep = "&")
series_cuss <- unique(series_cuss)
length(series_cuss) # 6911

#' Now all the series in CUSS are in all_areas_nuseds.
series_cuss[! series_cuss %in% series_nuseds]

# Number of series in NUSEDS not in CUSS:
series_Nuseds_noCuss <- series_nuseds[! series_nuseds %in% series_cuss]
series_Nuseds_noCuss <- series_Nuseds_noCuss[order(series_Nuseds_noCuss)]
length(series_Nuseds_noCuss) # 0

# all the GFE_ID in CUSS should have coordinates:
cond <- is.na(conservation_unit_system_sites$Y_LAT) | is.na(conservation_unit_system_sites$X_LONGT)
sum(cond) # 0
```

## Merge NuSEDS and CUSS and replace 0s by NAs

At this stage **NUSEDS** and **CUSS** have the same `r length(series_cuss)` time series and can consequently be merged using the common fields `IndexId` (i.e., `POP_ID`) and `GFE_ID`.

```{r}
col_common <- c("IndexId","POP_ID","GFE_ID")

col_nuseds <- c("SPECIES","WATERBODY","AREA","Year","MAX_ESTIMATE",
                "ENUMERATION_METHODS",            # 
                "ESTIMATE_CLASSIFICATION",
                "ESTIMATE_METHOD",
                "GAZETTED_NAME",
                "LOCAL_NAME_1",
                "LOCAL_NAME_2",
                "ADULT_PRESENCE",
                "JACK_PRESENCE")

col_cuss <- c("SPECIES_QUALIFIED","CU_NAME","CU_TYPE","FAZ_ACRO","JAZ_ACRO","MAZ_ACRO",
              "FULL_CU_IN","SYSTEM_SITE","Y_LAT","X_LONGT","IS_INDICATOR",
              "CU_LAT","CU_LONGT","coordinates_changed")

nuseds_final <- base::merge(x = all_areas_nuseds[,c(col_common,col_nuseds)], 
                            y = conservation_unit_system_sites[,c(col_common,col_cuss)], 
                            by = col_common, 
                            all.x = T)
```

```{r, include=FALSE}
nrow(nuseds_final)     # 307217
nrow(all_areas_nuseds) # 307217
```


## Replace zeros by NAs (optional)

```{r, include=FALSE}
cond <- nuseds_final$MAX_ESTIMATE == 0 & !is.na(nuseds_final$MAX_ESTIMATE)
nb_cases <- sum(cond) # 2996
prop_cases <- sum(cond)/nrow(nuseds_final) * 100
```

So far we have not been able to determine which zeros are actual 0s and those which should be NAs. We consequently implemented the option to replace all 0s by NAs (`r paste0("n = ",nb_cases)`, or `r paste0(round(prop_cases,2),"%")` of the data points).

Decision made:

```{r, echo=FALSE}

if(replace_zeros_byNAs){
  nuseds_final$MAX_ESTIMATE[cond] <- NA
  print("Zeros are replaced by NAs.")
}else{
  print("Zeros are NOT replaced by NAs.")
}
```

## Fix duplicated series and points

There are many cases where a CU in a given location (i.e., a unique `GFE_ID`) is associated to multiple series (i.e. `IndexId`/`POP_ID`), which should not happen. Observing these cases reveals clear duplicated data points or single data point that are not worth keeping. To fix these issues we proceed as follow:

- **Case 1**: one of the duplicated series has only one data point:

  - if it is complementary: merge to the other (longer) series
  
  - if it is in conflict or a duplicate: remove the focal series
  
- **Case 2**: the shorter series is 100% duplicated: removed the focal series

- **Case 3**: for the rest of the duplicated series, 

  - points that are conflictual or duplicated are summed up
  
  - points that are complementary are merged

The figures below show the time series before and after correction with the action made (i.e., "MERGED", "DELETED", "SUMMED") indicated 

There are three instance where a special fix is done, as indicated below in the corresponding figures.

```{r, echo=FALSE, fig.width=15, fig.height=15}
# Short cut for trouble shooting
# write.csv(all_areas_nuseds,paste0(wd_data,"/all_areas_nuseds_TEMP.csv"), row.names = F)
# write.csv(conservation_unit_system_sites,paste0(wd_data,"/conservation_unit_system_sites_TEMP.csv"), row.names = F)
# write.csv(removed_all,paste0(wd_data,"/removed_all_TEMP.csv"), row.names = F)
# write.csv(added_all,paste0(wd_data,"/added_all_TEMP.csv"), row.names = F)
# write.csv(nuseds_final,paste0(wd_data,"/nuseds_final_TEMP.csv"), row.names = F)

# all_areas_nuseds <- read.csv(paste0(wd_data,"/all_areas_nuseds_TEMP.csv"), header = T)
# conservation_unit_system_sites <- read.csv(paste0(wd_data,"/conservation_unit_system_sites_TEMP.csv"), header = T)
# removed_all <- read.csv(paste0(wd_data,"/removed_all_TEMP.csv"), header = T)
# added_all <- read.csv(paste0(wd_data,"/added_all_TEMP.csv"), header = T)
# nuseds_final <- read.csv(paste0(wd_data,"/nuseds_final_TEMP.csv"), header = T)

# create a new removed_all to ???
removed_all_new <- removed_all[NULL,]

#' obtain the list of fields in NuSEDS and CUSS that are related to (1) IndexID 
#' (POP_ID) and/or GFE_ID and those that are independent, 
#' This is used to ???
fields_l <- fields_IndexId_GFE_ID_fun(all_areas_nuseds = all_areas_nuseds,
                                      conservation_unit_system_sites = conservation_unit_system_sites)

# Return the fields in both NUSEDS and CUSS that are related to IndexId (= POP_ID)
fields_IndexId <- unique(c(fields_l$NUSEDS$IndexId,fields_l$CUSS$IndexId))
fields_IndexId <- fields_IndexId[fields_IndexId %in% colnames(nuseds_final)]

nuseds_CU_GFI_ID <- unique(nuseds_final[,c("SPECIES_QUALIFIED","CU_NAME","GFE_ID")])
# nrow(nuseds_CU_GFI_ID) # 6848

#' The loop below shows the time series before and after the correction.
#' The procedure consists in looking in each cases where for a given CU (i.e. 
#' unique CU_NAME and SPECIES_QUALIFIED) and location (i.e GFE_ID) if there are 
#' multiple IndexId (= POP_ID).
count <- 1
layout(matrix(1:2,nrow = 2))
par(mar = c(4,4.5,3.5,.5))
for(r in 1:nrow(nuseds_CU_GFI_ID)){
  # r <- 1 # case one
  # r <- 1410 # case 2
  # r <- 966 # case 3
  # r <- 1124 # "correct_exception" with  IndexId_focal == "CM_50537" & GFE_ID_here == 816
  # r <- 1422 #  "Case 3 - CN_2483 & GFE_ID_here == 142": there are three time series 
  # r <-  # "delete_exception" with  IndexId_focal == "CN_50619" & GFE_ID_here == 824

  CU_NAME_here <- nuseds_CU_GFI_ID$CU_NAME[r]
  GFE_ID_here <- nuseds_CU_GFI_ID$GFE_ID[r]
  SPECIES_QUALIFIED_here <- nuseds_CU_GFI_ID$SPECIES_QUALIFIED[r]
  
  cond_nuseds <- nuseds_final$CU_NAME == CU_NAME_here &
    nuseds_final$GFE_ID == GFE_ID_here &
    nuseds_final$SPECIES_QUALIFIED == SPECIES_QUALIFIED_here
  
  IndexId_here <- unique(nuseds_final$IndexId[cond_nuseds])
  
  if(length(IndexId_here) > 1){
    
    plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                            GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                            all_areas_nuseds = nuseds_final, 
                            main = "BEFORE")
    legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
    legend("topright",legend = c(paste0("count = ",count),
                                 paste0("r = ",r)),bty = 'n')
    
    # select the two time series:
    cond_nuseds_1 <- cond_nuseds & nuseds_final$IndexId == IndexId_here[1]
    cond_nuseds_2 <- cond_nuseds & nuseds_final$IndexId == IndexId_here[2]
    series_1 <- nuseds_final$MAX_ESTIMATE[cond_nuseds_1]
    names(series_1) <- nuseds_final$Year[cond_nuseds_1]
    series_2 <- nuseds_final$MAX_ESTIMATE[cond_nuseds_2]
    names(series_2) <- nuseds_final$Year[cond_nuseds_2]
    
    # the focal series should be the shortest one
    if(length(series_1) > length(series_2)){  # suggestion: only count the non NA values?
      IndexId_focal <- IndexId_here[2]
      IndexId_compare <- IndexId_here[1]
      series_focal <- series_2
      series_compare <- series_1
      cond_focal <- cond_nuseds_2
      cond_compare <- cond_nuseds_1
    }else{
      IndexId_focal <- IndexId_here[1]
      IndexId_compare <- IndexId_here[2]
      series_focal <- series_1
      series_compare <- series_2
      cond_focal <- cond_nuseds_1
      cond_compare <- cond_nuseds_2
    }
    
    comparison <- compare_series_fun(series_focal = series_focal,
                                     series_compare = series_compare)
    
    # series_compare[order(as.numeric(names(series_compare)))]
    
    # some extra cases spotted by eye
    delete_exception <- IndexId_focal == "CN_50619" & GFE_ID_here == 824 # here one data point is a duplicate, the other one almost is
    correct_exception <- IndexId_focal == "CM_50537" & GFE_ID_here == 816
    
#' - Case 1: if one data point
#'    - if complementary --> merge to longer series
#'    - if conflict or duplicate --> remove
    if(comparison$nb_dataPt == 1){
      
      # merge the focal series to series_compare
      if(comparison$complementary == 1){
        
        removed <- data.frame(IndexId = IndexId_focal,
                              GFE_ID = GFE_ID_here)
        removed$dataset <- "nuseds_final"
        removed$comment <- paste0("The one data point was merged to series ",
                                  IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                  " as it is the same CU: ",CU_NAME_here)
        removed_all_new <- rbind(removed_all_new,removed)
        
        # 1st edit IndexId related fields in nuseds_final
        # 2nd remove the row with only NA
        cond_focal_NA <- cond_focal & is.na(nuseds_final$MAX_ESTIMATE)
        cond_focal_NAno <-  cond_focal & !is.na(nuseds_final$MAX_ESTIMATE)
        for(f in fields_IndexId){
          # f <- fields_IndexId[1]
          nuseds_final[cond_focal_NAno,f] <- unique(nuseds_final[cond_compare,f])
        }
        nuseds_final <- nuseds_final[!cond_focal_NA,]
        
        plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                                GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                                all_areas_nuseds = nuseds_final, 
                                main = "AFTER")
        legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
        legend("topright",legend = "MERGED",bty = 'n')
        
      }else{ # discard it
        
        nuseds_final <- nuseds_final[!cond_focal,]
        
        removed <- data.frame(IndexId = IndexId_focal,
                              GFE_ID = GFE_ID_here)
        removed$dataset <- "nuseds_final"
        removed$comment <- paste0("The series had only one point in confict or duplicating the series ",
                                  IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                  " of the same CU: ",CU_NAME_here)
        removed_all_new <- rbind(removed_all_new,removed)
        
        plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                                GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                                all_areas_nuseds = nuseds_final,main = "AFTER")
        legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
        legend("topright",legend = "DELETED",bty = 'n')
      }
      
#' - Case 2: the shorter series is 100% duplicated --> removed
    }else if(comparison$nb_dataPt == comparison$duplicate | delete_exception){ 
      
      nuseds_final <- nuseds_final[!cond_focal,]
      
      removed <- data.frame(IndexId = IndexId_focal,
                            GFE_ID = GFE_ID_here)
      removed$dataset <- "nuseds_final"
      removed$comment <- paste0("The series was duplicating the series ",
                                IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                " of the same CU: ",CU_NAME_here)
      removed_all_new <- rbind(removed_all_new,removed)
      
      
      plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                              GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                              all_areas_nuseds = nuseds_final,main = "AFTER")
      legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
      legend("topright",legend = "DELETED",bty = 'n')
      
      if(delete_exception){
        print("Special fix (above): the two blue points are deleted; one is a duplicate, there other one is very close to be one.")
      }
      
    }else if(correct_exception){
      
      # 1st find the 9 data points that are duplicated with series_compare
      # return the years with matching abundances
      years_toRemove <- c()
      for(i in 1:length(series_focal)){
        # i <- 1
        yr_here <- names(series_focal)[i]
        val_compare <- series_compare[as.character(yr_here)]
        if(!is.na(val_compare) & !is.na(series_focal[i])){
          if(series_focal[i] == val_compare){
            years_toRemove <- c(years_toRemove,yr_here)
          }
        }
      }
      years_toRemove <- as.numeric(years_toRemove)
      years_toRemove <- years_toRemove[years_toRemove < 1960] # there is one duplicated points for later years but it looks legit
      
      cond_focal_YrtoRemove <- cond_focal & nuseds_final$Year %in% years_toRemove
      
      # 2nd merge the rest of the series by summing the data
      # change the field in the focal series
      for(f in fields_IndexId){
        # f <- fields_IndexId[1]
        nuseds_final[cond_focal,f] <- unique(nuseds_final[cond_compare,f])
      }
      # sum MAX_ESTIMATE in duplicated year
      cond_sum <- (cond_focal & !cond_focal_YrtoRemove) | cond_compare
      yr_duplicated <- nuseds_final[cond_sum,]$Year[duplicated(nuseds_final[cond_sum,]$Year)]
      for(yr in yr_duplicated){
        # yr <- yr_duplicated[1]
        cond_here <- (cond_focal | cond_compare) & nuseds_final$Year == yr
        vals <- nuseds_final$MAX_ESTIMATE[cond_here]
        if(any(!is.na(vals))){
          val <- sum(vals,na.rm = T)
          nuseds_final$MAX_ESTIMATE[cond_here] <- val
        }
      }
      
      # 3rd remove the row with duplicated data from 1st step and the rows with 
      # duplicated years in the focal from 2nd step
      cond_toDelete <- cond_focal_YrtoRemove | (cond_focal & nuseds_final$Year %in% yr_duplicated)
      nuseds_final <- nuseds_final[!cond_toDelete,]
      
      removed <- data.frame(IndexId = IndexId_focal,
                            GFE_ID = GFE_ID_here)
      removed$dataset <- "nuseds_final"
      removed$comment <- paste0("We removed the duplicated data points and merged by summing the rest of them to series ",
                                IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                " of the same CU: ",CU_NAME_here)
      removed_all_new <- rbind(removed_all_new,removed)
      
      plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                              GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                              all_areas_nuseds = nuseds_final,main = "AFTER")
      legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
      legend("topright",legend = "DELETED & MERGED",bty = 'n')
      
      if(correct_exception){
        print("Special fix (above): the blue points before 1950 are deleted, the other ones are summed to the red series.")
      }
      
#' - Case 3: on the rest of the series, 
#'    - points that are conflictual or duplicated are added
#'    - points that are complementary are merged
    }else{ 

      # plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
      #                         GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
      #                         all_areas_nuseds = nuseds_final,main = "AFTER")
      # legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
      
      if("CN_2483" %in% IndexId_here & GFE_ID_here == 142){
        
        # print("Case 3 - CN_2483 & GFE_ID_here == 142")
        
        # - 1) merge CN_47277 - 142 to CN_2483 - 142
        # - 2) remove the point CN_47278 - 142
        
        # 1) 
        # change the IndexId of focal series to the compared one
        cond_focal <- nuseds_final$IndexId == "CN_47277" & 
          nuseds_final$GFE_ID == 142
        cond_compare <- nuseds_final$IndexId == "CN_2483" & 
          nuseds_final$GFE_ID == 142
        
        for(f in fields_IndexId){
          # f <- fields_IndexId[1]
          nuseds_final[cond_focal,f] <- unique(nuseds_final[cond_compare,f])
        }
        
        removed <- data.frame(IndexId = "CN_47277",
                              GFE_ID = 142)
        removed$dataset <- "nuseds_final"
        removed$comment <- paste0("Series merged to series ",IndexId_compare,
                                  " & GFE_ID = ",GFE_ID_here," of the same CU: ",
                                  CU_NAME_here)
        removed_all_new <- rbind(removed_all_new,removed)
        
        # 2)
        cond_toRemove <- nuseds_final$IndexId == "CN_47278" & 
          nuseds_final$GFE_ID == 142
        
        nuseds_final <- nuseds_final[!cond_toRemove,]
        
        removed <- data.frame(IndexId = "CN_47278",
                              GFE_ID = 142)
        removed$dataset <- "nuseds_final"
        removed$comment <- paste0("The series had only one point in confict or duplicating the series ",
                                  IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                  " of the same CU: ",CU_NAME_here)
        removed_all_new <- rbind(removed_all_new,removed)
        
        plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                                GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                                all_areas_nuseds = nuseds_final, main = "AFTER")
        legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
        legend("topright",legend = "MERGED & DELETED",bty = 'n')
        
        print("Special fix (above): the blue points is deleted, the green series is merged to the red one.")
        
      }else{
        
        # 1st change the IndexId of focal series to the compared one
        for(f in fields_IndexId){
          # f <- fields_IndexId[1]
          nuseds_final[cond_focal,f] <- unique(nuseds_final[cond_compare,f])
        }
        
        # 2nd sum MAX_ESTIMATE values for duplicated years
        SUMMED <- F
        yr_duplicated <- nuseds_final[cond_focal | cond_compare,]$Year[duplicated(nuseds_final[cond_focal | cond_compare,]$Year)]
        for(yr in yr_duplicated){
          # yr <- yr_duplicated[1]
          cond_here <- (cond_focal | cond_compare) & nuseds_final$Year == yr
          vals <- nuseds_final$MAX_ESTIMATE[cond_here]
          if(any(!is.na(vals))){
            val <- sum(vals,na.rm = T)
            nuseds_final$MAX_ESTIMATE[cond_here] <- val
            SUMMED <- T
          }
        }
        
        # 3rd remove the rows with duplicated years in the focal
        cond_toDelete <- cond_focal & nuseds_final$Year %in% yr_duplicated
        nuseds_final <- nuseds_final[!cond_toDelete,]
        
        plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                                GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                                all_areas_nuseds = nuseds_final, main = "AFTER")
        legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
        if(SUMMED){
          legend("topright",legend = "MERGED & SUMMED",bty = 'n')
        }else{
          legend("topright",legend = "MERGED",bty = 'n')
        }
        
        removed <- data.frame(IndexId = IndexId_focal,
                              GFE_ID = GFE_ID_here)
        removed$dataset <- "nuseds_final"
        removed$comment <- paste0("Series merged by summing to series ",IndexId_compare," & GFE_ID = ",GFE_ID_here," of the same CU: ",CU_NAME_here)
        removed_all_new <- rbind(removed_all_new,removed)
        
      }
    }
    count <- count + 1
    print("***")
  }
}

removed_all <- rbind(removed_all,removed_all_new)
removed_all <- unique(removed_all)
```

# Export datasets

The following files are exported:

- *1_NuSEDS_escapement_data_collated_DATE.csv*: the cleaned combined **NUSEDS** and **CUSS** datasets

- *1_series_inNUSEDS_noInCUSS_DATE.csv*: information about the series in  **NUSEDS** and not in **CUSS**

- *1_series_removed_DATE.csv*: the series removed from either **NUSEDS** or **CUSS** and why

- *1_series_added_DATE.csv*: the series added to either **NUSEDS** or **CUSS** and why

- *1_log_file.csv*: the log file reporting the name of the original **NUSEDS** or **CUSS** files and the choices related to removing zeros or not.

```{r, include=FALSE}
if(export_datasets){
  
  date <- as.character(Sys.Date())
  
  # Export the merged and cleaned NuSEDS data
  write.csv(nuseds_final,paste0(wd_output,"/archive/1_NuSEDS_escapement_data_collated_",date,".csv"),
            row.names = F)
  
  #' Export the series in NUSEDS with IndexIds and GFE_IDs not in CUSS with 
  #' info on the number of data points and POPULATION
  #' slack: https://salmonwatersheds.slack.com/archives/CJ5RVHVCG/p1709250704372429
  
  cond <- trackRecord_nuseds$alternative_GFE_ID == "none" &
    trackRecord_nuseds$alternative_IndexId == "none"
  
  trackRecord_toExport <- trackRecord_nuseds[cond,c("IndexId","GFE_ID","nb_dataPt")]
  
  trackRecord_toExport$POP_ID <- apply(X = trackRecord_toExport, 1, 
                                       FUN = function(r){
                                         iid <- r["IndexId"]
                                         popid <- strsplit(x = iid, split = "_")[[1]][2]
                                         return(popid)
                                       })
  
  trackRecord_toExport$POPULATION <- apply(X = trackRecord_toExport, 1, 
                                           FUN = function(r){
                                             iid <- r["IndexId"]
                                             gfeid <- r["GFE_ID"]
                                             cond <- all_areas_nuseds_all$IndexId == iid &
                                               all_areas_nuseds_all$GFE_ID == gfeid
                                             return(unique(all_areas_nuseds_all$POPULATION[cond]))
                                           })
  
  trackRecord_toExport$POP_ID <- sapply(X = trackRecord_toExport$IndexId, 
                                        FUN = function(iid){strsplit(x = iid,split = "_")[[1]][2]})
  
  trackRecord_toExport$species_acro <- sapply(X = trackRecord_toExport$IndexId, 
                                              FUN = function(iid){strsplit(x = iid,split = "_")[[1]][1]}) 
  
  trackRecord_toExport <- trackRecord_toExport[,c("IndexId","POP_ID","species_acro",
                                                  "GFE_ID","nb_dataPt","POPULATION")]
  
  write.csv(trackRecord_toExport,paste0(wd_output,"/archive/1_series_inNUSEDS_noInCUSS_",date,".csv"),
            row.names = F)
  
  
  #' Export the CUs removed and those added:
  removed_all$POP_ID <- sapply(X = removed_all$IndexId, 
                               FUN = function(iid){strsplit(x = iid,split = "_")[[1]][2]})
  
  removed_all$species_acro <- sapply(X = removed_all$IndexId, 
                                     FUN = function(iid){strsplit(x = iid,split = "_")[[1]][1]}) 
  
  removed_all <- removed_all[,c("IndexId","POP_ID","species_acro","GFE_ID","dataset","comment")]
  
  write.csv(removed_all,paste0(wd_output,"/archive/1_series_removed_",date,".csv"),row.names = F)
  
  #
  added_all$POP_ID <- sapply(X = added_all$IndexId, 
                             FUN = function(iid){strsplit(x = iid,split = "_")[[1]][2]})
  
  added_all$species_acro <- sapply(X = added_all$IndexId, 
                                   FUN = function(iid){strsplit(x = iid,split = "_")[[1]][1]}) 
  
  added_all <- added_all[,c("IndexId","POP_ID","species_acro","CU_NAME","GFE_ID","dataset","comment")]
  
  
  write.csv(added_all,paste0(wd_output,"/archive/1_series_added_",date,".csv"),row.names = F)
  
  
  # Edit the log file
  log_file <- read.csv(paste0(wd_output,"/1_log_file.csv"),header = T)
  log_file_new <- log_file[1,]
  log_file_new$date_export <- date
  log_file_new$all_areas_nuseds_file_name <- all_areas_nuseds_file_name
  log_file_new$conservation_unit_system_sites_file_name <- conservation_unit_system_sites_file_name
  log_file_new$remove_timeSeries_zeros_too <- remove_timeSeries_zeros_too
  log_file_new$replace_zeros_byNAs <- replace_zeros_byNAs
  
  log_file <- rbind(log_file,log_file_new)
  write.csv(log_file,paste0(wd_output,"/1_log_file.csv"),row.names = T)
  
}

```
